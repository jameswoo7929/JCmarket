<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JCmarket 購物網</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Custom Styles */
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; }
        .hide { display: none !important; }
        .modal { background-color: rgba(0,0,0,0.5); }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Product Card Hover Effect */
        .product-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
    </style>
</head>
<body class="text-gray-800">

    <!-- Notifications Container -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 flex flex-col gap-2"></div>

    <!-- LOGIN PAGE -->
    <section id="page-login" class="min-h-screen flex items-center justify-center bg-blue-50">
        <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-md">
            <h1 class="text-3xl font-bold text-center text-pink-600 mb-2">JCmarket</h1>
            <p class="text-center text-gray-500 mb-6">購物網站登入系統</p>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">帳號 (身分證字號)</label>
                    <input type="text" id="login-username" placeholder="例：A123456789" class="mt-1 block w-full border border-gray-300 rounded-md p-2 focus:ring-pink-500 focus:border-pink-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">密碼</label>
                    <input type="password" id="login-password" placeholder="身分證後4碼+生日(YYMMDD) 共10碼" class="mt-1 block w-full border border-gray-300 rounded-md p-2 focus:ring-pink-500 focus:border-pink-500">
                </div>
                <button onclick="handleLogin()" class="w-full bg-pink-600 text-white py-2 rounded-md hover:bg-pink-700 transition">登入 / 註冊</button>
            </div>
            
            <div class="mt-4 text-xs text-gray-500 bg-gray-100 p-3 rounded">
                <p><strong>首次登入說明：</strong></p>
                <p>請輸入您的身分證字號作為帳號。</p>
                <p>密碼規則：身分證後4碼 + 生日西元年末兩碼月兩碼日兩碼 (共10碼)。</p>
                <p>例如：身分證 A12345<strong>6789</strong>，生日 1999/01/01 (990101)</p>
                <p>密碼為：<strong>6789990101</strong></p>
                <p>首次輸入正確格式後，系統將引導您填寫基本資料。</p>
                <p class="mt-2 text-blue-600">管理員測試帳號：admin / admin</p>
            </div>
        </div>
    </section>

    <!-- REGISTER PAGE -->
    <section id="view-register" class="hide min-h-screen flex items-center justify-center bg-blue-50">
        <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-md">
            <h2 class="text-2xl font-bold text-center text-pink-600 mb-6">會員資料填寫</h2>
            <p class="text-sm text-gray-500 mb-4 text-center">請完成基本資料以送出審核</p>
            
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">帳號 (唯讀)</label>
                        <input type="text" id="reg-id" class="mt-1 block w-full bg-gray-100 border border-gray-300 rounded-md p-2 text-gray-500 cursor-not-allowed" readonly>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">生日 (唯讀)</label>
                        <input type="text" id="reg-birthday" class="mt-1 block w-full bg-gray-100 border border-gray-300 rounded-md p-2 text-gray-500 cursor-not-allowed" readonly>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700">真實姓名 <span class="text-red-500">*</span></label>
                    <input type="text" id="reg-name" placeholder="請輸入姓名" class="mt-1 block w-full border border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700">性別 <span class="text-red-500">*</span></label>
                    <select id="reg-gender" class="mt-1 block w-full border border-gray-300 rounded-md p-2 bg-white">
                        <option value="male">男</option>
                        <option value="female">女</option>
                        <option value="other">其他</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700">聯絡電話 <span class="text-red-500">*</span></label>
                    <input type="tel" id="reg-phone" placeholder="例：0912345678" class="mt-1 block w-full border border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <button onclick="submitRegistration()" class="w-full bg-green-600 text-white py-2 rounded-md hover:bg-green-700 transition shadow">送出申請</button>
                <button onclick="cancelRegistration()" class="w-full bg-gray-300 text-gray-700 py-2 rounded-md hover:bg-gray-400 transition">取消返回</button>
            </div>
        </div>
    </section>

    <!-- MAIN APP LAYOUT (Header + Content) -->
    <div id="app-layout" class="hide min-h-screen flex flex-col">
        
        <!-- Header -->
        <header class="bg-pink-600 text-white shadow-md sticky top-0 z-40">
            <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <h1 class="text-2xl font-bold cursor-pointer" onclick="router('shop')">JCmarket</h1>
                    <span id="nav-welcome" class="text-sm bg-pink-700 px-2 py-1 rounded">歡迎, 會員</span>
                </div>
                
                <nav class="flex items-center gap-4">
                    <!-- User Nav -->
                    <div id="nav-user" class="flex items-center gap-4">
                        <button onclick="router('shop')" class="hover:text-pink-200"><i class="fas fa-home"></i> 首頁</button>
                        <button onclick="router('cart')" class="hover:text-pink-200 relative">
                            <i class="fas fa-shopping-cart"></i> 購物車
                            <span id="cart-count" class="absolute -top-2 -right-2 bg-yellow-400 text-pink-800 text-xs font-bold px-1.5 rounded-full">0</span>
                        </button>
                        <button onclick="router('profile')" class="hover:text-pink-200 relative">
                            <i class="fas fa-user"></i> 會員中心
                            <span id="msg-badge" class="hide absolute -top-1 -right-1 w-2 h-2 bg-red-500 rounded-full"></span>
                        </button>
                    </div>

                    <!-- Admin Switch (Visible only to Admin) -->
                    <button id="btn-admin-switch" onclick="router('admin')" class="hide bg-gray-800 text-white px-3 py-1 rounded hover:bg-gray-700 text-sm border border-gray-600 shadow-sm">
                        <i class="fas fa-cogs"></i> 回到後台
                    </button>

                    <button onclick="logout()" class="text-sm border border-white px-2 py-1 rounded hover:bg-white hover:text-pink-600">登出</button>
                </nav>
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="flex-grow container mx-auto px-4 py-6">
            
            <!-- SHOP VIEW -->
            <section id="view-shop" class="hide">
                <!-- Categories -->
                <div class="flex gap-2 overflow-x-auto pb-4 mb-4 scrollbar-hide" id="category-list">
                    <!-- Injected via JS -->
                </div>

                <!-- Product Grid -->
                <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4" id="product-grid">
                    <!-- Injected via JS -->
                </div>
            </section>

            <!-- CART VIEW -->
            <section id="view-cart" class="hide max-w-4xl mx-auto">
                <h2 class="text-2xl font-bold mb-4 border-b pb-2">購物車</h2>
                <div id="cart-items" class="bg-white rounded shadow p-4 mb-4">
                    <!-- Items -->
                </div>
                <div class="bg-white rounded shadow p-4 text-right">
                    <p class="text-xl font-bold text-pink-600">總金額: $<span id="cart-total">0</span></p>
                    <button onclick="submitOrder()" class="mt-4 bg-pink-600 text-white px-6 py-2 rounded hover:bg-pink-700">送出訂單 (待核對)</button>
                </div>
            </section>

            <!-- PROFILE VIEW -->
            <section id="view-profile" class="hide max-w-4xl mx-auto">
                <div class="grid md:grid-cols-3 gap-6">
                    <!-- Info -->
                    <div class="bg-white p-4 rounded shadow">
                        <h3 class="font-bold text-lg mb-4">會員資料</h3>
                        <div id="profile-info" class="text-sm space-y-2"></div>
                        <div class="mt-4 pt-4 border-t">
                             <h4 class="font-bold mb-2">更改密碼</h4>
                             <input type="password" id="new-password" placeholder="新密碼" class="w-full border p-1 mb-2 text-sm">
                             <button onclick="updatePassword()" class="bg-gray-600 text-white px-3 py-1 text-sm rounded">更新</button>
                        </div>
                    </div>
                    
                    <!-- Orders & Messages -->
                    <div class="md:col-span-2 bg-white p-4 rounded shadow">
                        <h3 class="font-bold text-lg mb-4">訂單與訊息</h3>
                        
                        <!-- Chat Box -->
                        <div class="border rounded h-64 overflow-y-auto p-3 mb-3 bg-gray-50 flex flex-col gap-2" id="chat-box">
                            <!-- Messages -->
                        </div>
                        <div class="flex gap-2">
                            <input type="text" id="chat-input" class="flex-grow border p-2 rounded" placeholder="傳送訊息給管理員...">
                            <button onclick="sendMessage('user')" class="bg-blue-600 text-white px-4 rounded">傳送</button>
                        </div>

                        <h4 class="font-bold mt-6 mb-2">歷史訂單</h4>
                        <div id="profile-orders" class="space-y-3">
                            <!-- Order History -->
                        </div>
                    </div>
                </div>
            </section>

            <!-- ADMIN DASHBOARD -->
            <section id="view-admin" class="hide">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">後台管理系統</h2>
                    <div class="space-x-2 flex items-center">
                         <button onclick="router('shop')" class="bg-indigo-600 text-white px-4 py-2 rounded text-sm hover:bg-indigo-700 shadow flex items-center gap-2">
                             <i class="fas fa-store"></i> 切換至前台購物
                         </button>
                         <span class="text-gray-300">|</span>
                         <button onclick="exportData()" class="bg-green-600 text-white px-3 py-1 rounded text-sm"><i class="fas fa-download"></i> 匯出</button>
                         <button onclick="document.getElementById('import-file').click()" class="bg-blue-600 text-white px-3 py-1 rounded text-sm"><i class="fas fa-upload"></i> 匯入</button>
                         <input type="file" id="import-file" class="hidden" onchange="importData(this)">
                    </div>
                </div>

                <!-- Admin Tabs -->
                <div class="flex gap-1 mb-4 border-b overflow-x-auto">
                    <button class="px-4 py-2 bg-gray-200 rounded-t active-tab whitespace-nowrap" onclick="switchAdminTab('orders', this)">訂單管理</button>
                    <button class="px-4 py-2 bg-gray-100 rounded-t whitespace-nowrap" onclick="switchAdminTab('products', this)">商品管理</button>
                    <button class="px-4 py-2 bg-gray-100 rounded-t whitespace-nowrap" onclick="switchAdminTab('users', this)">會員管理</button>
                    <button class="px-4 py-2 bg-gray-100 rounded-t whitespace-nowrap" onclick="switchAdminTab('messages', this)">訊息中心 <span id="admin-msg-badge" class="hide bg-red-500 text-white text-[10px] px-1 rounded-full">New</span></button>
                </div>

                <!-- Admin Content -->
                <div id="admin-content-orders" class="admin-tab-content">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <h3 class="font-bold mb-2 text-yellow-600">待核對訂單</h3>
                            <div id="admin-orders-pending" class="space-y-3"></div>
                        </div>
                        <div>
                            <h3 class="font-bold mb-2 text-green-600">已成立訂單 (按時間)</h3>
                            <div id="admin-orders-confirmed" class="space-y-3"></div>
                        </div>
                    </div>
                </div>

                <div id="admin-content-products" class="admin-tab-content hide">
                    <div class="mb-4 bg-white p-4 rounded shadow">
                        <h4 class="font-bold mb-2">新增/修改商品</h4>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                            <input type="text" id="prod-name" placeholder="商品名稱" class="border p-2 rounded">
                            <input type="number" id="prod-price" placeholder="價格" class="border p-2 rounded">
                            <input type="text" id="prod-cat" placeholder="分類 (例: 3C)" class="border p-2 rounded">
                            <input type="text" id="prod-img" placeholder="圖片網址" class="border p-2 rounded">
                        </div>
                        <button onclick="saveProduct()" class="mt-2 bg-pink-600 text-white px-4 py-2 rounded">儲存商品</button>
                        <button onclick="resetProductForm()" class="mt-2 bg-gray-400 text-white px-4 py-2 rounded">重設</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full bg-white shadow rounded text-sm text-left">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="p-3">ID</th>
                                    <th class="p-3">圖片</th>
                                    <th class="p-3">名稱</th>
                                    <th class="p-3">分類</th>
                                    <th class="p-3">價格</th>
                                    <th class="p-3">操作</th>
                                </tr>
                            </thead>
                            <tbody id="admin-product-list"></tbody>
                        </table>
                    </div>
                </div>

                <div id="admin-content-users" class="admin-tab-content hide">
                    <div class="overflow-x-auto">
                        <table class="w-full bg-white shadow rounded text-sm text-left">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="p-3">帳號 (ID)</th>
                                    <th class="p-3">資料</th>
                                    <th class="p-3">狀態</th>
                                    <th class="p-3">等級</th>
                                    <th class="p-3">操作</th>
                                </tr>
                            </thead>
                            <tbody id="admin-user-list"></tbody>
                        </table>
                    </div>
                </div>

                <div id="admin-content-messages" class="admin-tab-content hide">
                    <div class="grid md:grid-cols-3 gap-4 h-[600px]">
                        <!-- Message List -->
                        <div class="md:col-span-1 bg-white shadow rounded overflow-y-auto" id="admin-msg-list">
                            <!-- List of users who messaged -->
                        </div>
                        <!-- Chat View -->
                        <div class="md:col-span-2 bg-white shadow rounded flex flex-col">
                            <div id="admin-chat-header" class="p-3 border-b font-bold bg-gray-50">
                                請選擇對話
                            </div>
                            <div id="admin-chat-box" class="flex-grow p-4 overflow-y-auto bg-gray-50 space-y-3"></div>
                            <div class="p-3 border-t flex gap-2">
                                <input type="text" id="admin-chat-input" class="flex-grow border rounded p-2" placeholder="輸入回覆..." disabled>
                                <button onclick="adminSendMsg()" id="admin-chat-send-btn" class="bg-blue-600 text-white px-4 rounded disabled:bg-gray-400" disabled>發送</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- MODALS -->
    <!-- Order Review Modal (Admin) -->
    <div id="modal-order-review" class="fixed inset-0 modal hide flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold mb-4">訂單核對 & 價格調整</h3>
            <div id="order-review-items" class="space-y-2 mb-4"></div>
            <div class="flex justify-between items-center bg-gray-100 p-3 rounded mb-4">
                 <span>原始總額: $<span id="review-original-total">0</span></span>
                 <span class="font-bold text-pink-600 text-lg">調整後總額: $<span id="review-final-total">0</span></span>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-bold mb-1">給會員的留言/通知</label>
                <textarea id="review-msg" class="w-full border p-2 rounded h-20" placeholder="例：商品確認無誤，請匯款至..."></textarea>
            </div>

            <div class="flex justify-end gap-2">
                <button onclick="closeModal('modal-order-review')" class="bg-gray-300 px-4 py-2 rounded">取消</button>
                <button onclick="confirmOrderAction()" class="bg-green-600 text-white px-4 py-2 rounded">確認訂單並通知</button>
            </div>
        </div>
    </div>

    <!-- Product Detail Modal -->
    <div id="modal-product" class="fixed inset-0 modal hide flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg w-full max-w-md relative">
            <button onclick="closeModal('modal-product')" class="absolute top-2 right-2 text-gray-500 hover:text-black"><i class="fas fa-times"></i></button>
            <img id="modal-p-img" src="" class="w-full h-48 object-cover rounded mb-4">
            <span id="modal-p-cat" class="text-xs bg-gray-200 px-2 py-1 rounded text-gray-600"></span>
            <h3 id="modal-p-name" class="text-xl font-bold mt-2"></h3>
            <div class="flex justify-between items-end mt-2 mb-4">
                <div>
                    <span class="text-gray-400 line-through text-sm">原價 $<span id="modal-p-price"></span></span>
                    <br>
                    <span class="text-2xl font-bold text-pink-600">$<span id="modal-p-disc-price"></span></span>
                    <span class="text-xs text-red-500 ml-1" id="modal-p-discount-tag"></span>
                </div>
            </div>
            <button id="btn-add-to-cart" class="w-full bg-pink-600 text-white py-2 rounded hover:bg-pink-700">加入購物車</button>
        </div>
    </div>

    <script>
        // --- DATA & STATE ---
        const DB_KEYS = {
            USERS: 'jc_users',
            PRODUCTS: 'jc_products',
            ORDERS: 'jc_orders',
            MESSAGES: 'jc_messages',
            CURRENT_USER: 'jc_current_user'
        };

        // Initial Data Seeding
        const initialProducts = [
            { id: 1, name: "Apple iPhone 15 Pro", price: 36900, category: "3C", img: "https://placehold.co/400x400/333/FFF?text=iPhone+15" },
            { id: 2, name: "Dyson 吹風機", price: 12900, category: "家電", img: "https://placehold.co/400x400/pink/FFF?text=Dyson" },
            { id: 3, name: "SK-II 青春露", price: 4500, category: "美妝", img: "https://placehold.co/400x400/red/FFF?text=SK-II" },
            { id: 4, name: "Nike 慢跑鞋", price: 2800, category: "運動", img: "https://placehold.co/400x400/orange/FFF?text=Nike" },
            { id: 5, name: "Sony WH-1000XM5", price: 9900, category: "3C", img: "https://placehold.co/400x400/black/FFF?text=Sony" },
            { id: 6, name: "衛生紙一箱", price: 899, category: "日用", img: "https://placehold.co/400x400/white/333?text=Tissue" }
        ];

        let currentUser = null;
        let cart = [];
        let editingProductId = null;
        let reviewingOrder = null;
        let adminChatTarget = null; 
        let tempRegisterAuth = null; // Store temp credentials for registration

        // --- INIT ---
        window.onload = function() {
            if(!localStorage.getItem(DB_KEYS.USERS)) {
                // Seed Admin
                const admin = { id: 'admin', pass: 'admin', role: 'admin', name: '管理員', status: 'active', level: 1 };
                localStorage.setItem(DB_KEYS.USERS, JSON.stringify([admin]));
            }
            if(!localStorage.getItem(DB_KEYS.PRODUCTS)) {
                localStorage.setItem(DB_KEYS.PRODUCTS, JSON.stringify(initialProducts));
            }
            if(!localStorage.getItem(DB_KEYS.ORDERS)) localStorage.setItem(DB_KEYS.ORDERS, JSON.stringify([]));
            if(!localStorage.getItem(DB_KEYS.MESSAGES)) localStorage.setItem(DB_KEYS.MESSAGES, JSON.stringify([]));

            checkSession();
        };

        // --- AUTH SYSTEM ---
        function checkSession() {
            const stored = sessionStorage.getItem(DB_KEYS.CURRENT_USER);
            if (stored) {
                currentUser = JSON.parse(stored);
                initApp();
            } else {
                document.getElementById('page-login').classList.remove('hide');
                document.getElementById('app-layout').classList.add('hide');
                document.getElementById('view-register').classList.add('hide');
            }
        }

        function handleLogin() {
            const userIn = document.getElementById('login-username').value.trim();
            const passIn = document.getElementById('login-password').value.trim();
            
            if(!userIn || !passIn) return toast('請輸入帳號密碼', 'error');

            const users = JSON.parse(localStorage.getItem(DB_KEYS.USERS));
            const user = users.find(u => u.id === userIn);

            if (user) {
                // Existing user
                if (user.pass === passIn) {
                    // Check Status
                    if (user.status === 'pending') {
                        toast('帳號審核中，請等待管理員通知', 'warning');
                        return;
                    }
                    // Login
                    loginSuccess(user);
                } else {
                    toast('密碼錯誤', 'error');
                }
            } else {
                // New User -> Redirect to Register View
                // Validate ID format (Simple Check: Start with Letter, length 10)
                const idRegex = /^[A-Z][0-9]{9}$/;
                if (!idRegex.test(userIn)) return toast('帳號格式錯誤，請輸入身分證字號', 'error');

                // Validate Password format (Last 4 ID + 6 date digits = 10 digits)
                const last4Id = userIn.slice(-4);
                const passRegex = new RegExp(`^${last4Id}\\d{6}$`);
                
                if (!passRegex.test(passIn)) {
                    return toast('首次登入密碼格式錯誤 (身分證後4碼+生日6碼)', 'error');
                }

                // Prepare Registration View
                tempRegisterAuth = { id: userIn, pass: passIn };
                
                // Extract birthday from password (last 6 digits: YYMMDD)
                const rawDate = passIn.slice(-6); // e.g., 990101
                const formattedBirthday = `${rawDate.substring(0,2)}/${rawDate.substring(2,4)}/${rawDate.substring(4,6)}`;

                document.getElementById('reg-id').value = userIn;
                document.getElementById('reg-birthday').value = `19${formattedBirthday}`; // Simplified assumption for demo
                document.getElementById('reg-name').value = '';
                document.getElementById('reg-phone').value = '';
                
                document.getElementById('page-login').classList.add('hide');
                document.getElementById('view-register').classList.remove('hide');
                
                toast('驗證成功，請填寫詳細資料以完成註冊', 'info');
            }
        }

        function submitRegistration() {
            const name = document.getElementById('reg-name').value.trim();
            const gender = document.getElementById('reg-gender').value;
            const phone = document.getElementById('reg-phone').value.trim();
            const birthday = document.getElementById('reg-birthday').value;

            if(!name || !phone) return toast('請填寫完整姓名與電話', 'error');
            if(!tempRegisterAuth) return toast('驗證失效，請重新登入', 'error');

            const users = JSON.parse(localStorage.getItem(DB_KEYS.USERS));
            
            // Double check duplicate
            if(users.some(u => u.id === tempRegisterAuth.id)) {
                toast('此帳號已存在', 'error');
                cancelRegistration();
                return;
            }

            // Create Pending User
            const newUser = {
                id: tempRegisterAuth.id,
                pass: tempRegisterAuth.pass,
                role: 'user',
                name: name,
                gender: gender,
                phone: phone,
                birthday: birthday,
                status: 'pending',
                level: 0, 
                joined: new Date().toISOString()
            };
            
            users.push(newUser);
            localStorage.setItem(DB_KEYS.USERS, JSON.stringify(users));
            
            // Notify Admin
            addMessage('system', 'admin', `會員申請: ${newUser.name} (${newUser.id}) 已提交資料，待審核。`);
            
            // Clear and Redirect
            tempRegisterAuth = null;
            document.getElementById('view-register').classList.add('hide');
            document.getElementById('page-login').classList.remove('hide');
            document.getElementById('login-username').value = '';
            document.getElementById('login-password').value = '';

            toast('資料已送出！請等待管理員審核通知', 'success');
        }

        function cancelRegistration() {
            tempRegisterAuth = null;
            document.getElementById('view-register').classList.add('hide');
            document.getElementById('page-login').classList.remove('hide');
        }

        function loginSuccess(user) {
            currentUser = user;
            sessionStorage.setItem(DB_KEYS.CURRENT_USER, JSON.stringify(user));
            document.getElementById('page-login').classList.add('hide');
            initApp();
        }

        function logout() {
            // FIX: Do not use location.reload() to avoid clearing local storage in preview environments
            currentUser = null;
            sessionStorage.removeItem(DB_KEYS.CURRENT_USER);
            
            // UI Reset
            document.getElementById('app-layout').classList.add('hide');
            document.getElementById('view-register').classList.add('hide');
            document.getElementById('page-login').classList.remove('hide');
            
            // Clear inputs
            document.getElementById('login-username').value = '';
            document.getElementById('login-password').value = '';
            
            // Clear specific state
            cart = [];
            adminChatTarget = null;
            
            toast('已登出', 'info');
        }

        // --- APP LOGIC ---
        function initApp() {
            document.getElementById('app-layout').classList.remove('hide');
            
            // Setup UI based on role
            document.getElementById('nav-welcome').innerText = `歡迎, ${currentUser.name}`;
            
            if (currentUser.role === 'admin') {
                document.getElementById('btn-admin-switch').classList.remove('hide');
                document.getElementById('nav-user').classList.add('hide'); 
                checkAdminBadges();
                router('admin');
            } else {
                document.getElementById('btn-admin-switch').classList.add('hide');
                document.getElementById('nav-user').classList.remove('hide');
                router('shop');
            }

            renderShop();
            updateCartCount();
        }

        function router(viewName) {
            // Hide all views
            ['shop', 'cart', 'profile', 'admin'].forEach(v => document.getElementById(`view-${v}`).classList.add('hide'));
            
            // Show selected
            document.getElementById(`view-${viewName}`).classList.remove('hide');

            if (viewName === 'shop') renderShop();
            if (viewName === 'cart') renderCart();
            if (viewName === 'profile') renderProfile();
            if (viewName === 'admin') {
                if(currentUser.role !== 'admin') {
                    toast('無權限', 'error');
                    router('shop');
                    return;
                }
                renderAdmin();
            }
        }

        // --- SHOP & PRODUCTS ---
        function renderShop() {
            const products = JSON.parse(localStorage.getItem(DB_KEYS.PRODUCTS));
            const grid = document.getElementById('product-grid');
            const catList = document.getElementById('category-list');
            
            // Categories
            const categories = ['全部', ...new Set(products.map(p => p.category))];
            catList.innerHTML = categories.map(c => 
                `<button onclick="filterShop('${c}')" class="whitespace-nowrap px-4 py-1 rounded-full bg-white border hover:bg-pink-50">${c}</button>`
            ).join('');

            // Products
            filterShop('全部');
        }

        function filterShop(cat) {
            const products = JSON.parse(localStorage.getItem(DB_KEYS.PRODUCTS));
            const grid = document.getElementById('product-grid');
            const filtered = cat === '全部' ? products : products.filter(p => p.category === cat);
            
            grid.innerHTML = filtered.map(p => {
                const discount = getMemberDiscount();
                const finalPrice = Math.floor(p.price * discount);
                return `
                <div class="product-card bg-white p-4 rounded shadow cursor-pointer transition" onclick="openProductModal(${p.id})">
                    <img src="${p.img}" class="w-full h-40 object-cover rounded mb-2 bg-gray-200" onerror="this.src='https://placehold.co/400?text=No+Image'">
                    <span class="text-xs text-gray-500">${p.category}</span>
                    <h3 class="font-bold text-gray-800 text-sm h-10 overflow-hidden">${p.name}</h3>
                    <div class="mt-2 flex justify-between items-center">
                        <span class="font-bold text-pink-600">$${finalPrice}</span>
                        ${discount < 1 ? '<span class="text-xs bg-red-100 text-red-600 px-1 rounded">會員價</span>' : ''}
                    </div>
                </div>
                `;
            }).join('');
        }

        function getMemberDiscount() {
            if (!currentUser) return 1;
            // Level 0: 100%, Level 1 (VIP): 95%, Level 2: 90%
            const level = currentUser.level || 0;
            if (level === 1) return 0.95;
            if (level >= 2) return 0.90;
            return 1;
        }

        function openProductModal(pid) {
            const products = JSON.parse(localStorage.getItem(DB_KEYS.PRODUCTS));
            const p = products.find(i => i.id === pid);
            if(!p) return;

            const discount = getMemberDiscount();
            const finalPrice = Math.floor(p.price * discount);

            document.getElementById('modal-p-img').src = p.img;
            document.getElementById('modal-p-cat').innerText = p.category;
            document.getElementById('modal-p-name').innerText = p.name;
            document.getElementById('modal-p-price').innerText = p.price;
            document.getElementById('modal-p-disc-price').innerText = finalPrice;
            document.getElementById('modal-p-discount-tag').innerText = discount < 1 ? `(會員專屬 ${discount*10}折)` : '';
            
            const btn = document.getElementById('btn-add-to-cart');
            btn.onclick = () => addToCart(p);

            document.getElementById('modal-product').classList.remove('hide');
        }

        function closeModal(id) {
            document.getElementById(id).classList.add('hide');
        }

        // --- CART & ORDERS ---
        function addToCart(product) {
            const discount = getMemberDiscount();
            const finalPrice = Math.floor(product.price * discount);
            
            const existing = cart.find(item => item.id === product.id);
            if(existing) {
                existing.qty++;
            } else {
                cart.push({ ...product, qty: 1, finalPrice: finalPrice, originalPrice: product.price });
            }
            
            updateCartCount();
            closeModal('modal-product');
            toast('已加入購物車', 'success');
        }

        function updateCartCount() {
            document.getElementById('cart-count').innerText = cart.reduce((acc, item) => acc + item.qty, 0);
        }

        function renderCart() {
            const container = document.getElementById('cart-items');
            if(cart.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-4">購物車是空的</p>';
                document.getElementById('cart-total').innerText = '0';
                return;
            }

            let total = 0;
            container.innerHTML = cart.map((item, idx) => {
                const subtotal = item.finalPrice * item.qty;
                total += subtotal;
                return `
                <div class="flex justify-between items-center border-b py-2">
                    <div class="flex items-center gap-2">
                        <img src="${item.img}" class="w-12 h-12 rounded object-cover">
                        <div>
                            <p class="font-bold text-sm">${item.name}</p>
                            <p class="text-xs text-gray-500">單價 $${item.finalPrice}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <button onclick="updateCartQty(${idx}, -1)" class="bg-gray-200 w-6 h-6 rounded">-</button>
                        <span>${item.qty}</span>
                        <button onclick="updateCartQty(${idx}, 1)" class="bg-gray-200 w-6 h-6 rounded">+</button>
                    </div>
                </div>
                `;
            }).join('');
            document.getElementById('cart-total').innerText = total;
        }

        function updateCartQty(idx, change) {
            cart[idx].qty += change;
            if(cart[idx].qty <= 0) cart.splice(idx, 1);
            renderCart();
            updateCartCount();
        }

        function submitOrder() {
            if(cart.length === 0) return toast('購物車是空的', 'error');

            const orders = JSON.parse(localStorage.getItem(DB_KEYS.ORDERS));
            const total = cart.reduce((acc, item) => acc + (item.finalPrice * item.qty), 0);
            
            const newOrder = {
                oid: 'ORD-' + Date.now(),
                uid: currentUser.id,
                items: [...cart], // Clone
                total: total,
                status: 'pending', // pending -> checked -> confirmed
                timestamp: new Date().toISOString(),
                adminNote: ''
            };

            orders.push(newOrder);
            localStorage.setItem(DB_KEYS.ORDERS, JSON.stringify(orders));
            
            // Notify Admin
            addMessage('system', 'admin', `新訂單 ${newOrder.oid} 待核對 (會員: ${currentUser.name})`);

            cart = [];
            updateCartCount();
            router('profile');
            toast('訂單已送出，等待管理員核對', 'success');
        }

        // --- PROFILE & MESSAGES ---
        function renderProfile() {
            document.getElementById('profile-info').innerHTML = `
                <p>帳號: ${currentUser.id}</p>
                <p>姓名: ${currentUser.name}</p>
                <p>電話: ${currentUser.phone || '無'}</p>
                <p>等級: ${currentUser.level === 1 ? '<span class="text-yellow-600 font-bold">VIP</span>' : '一般會員'}</p>
            `;

            // Orders
            const allOrders = JSON.parse(localStorage.getItem(DB_KEYS.ORDERS));
            const myOrders = allOrders.filter(o => o.uid === currentUser.id).sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            document.getElementById('profile-orders').innerHTML = myOrders.map(o => {
                let statusClass = 'bg-gray-200 text-gray-700';
                let statusText = '待核對';
                if(o.status === 'confirmed') { statusClass = 'bg-green-100 text-green-700'; statusText = '訂單成立'; }
                
                return `
                <div class="border p-3 rounded">
                    <div class="flex justify-between mb-2">
                        <span class="font-mono font-bold">${o.oid}</span>
                        <span class="text-xs px-2 py-1 rounded ${statusClass}">${statusText}</span>
                    </div>
                    <p class="text-sm text-gray-600">總金額: $${o.total}</p>
                    ${o.adminNote ? `<p class="text-xs bg-blue-50 p-2 mt-2 rounded text-blue-800"><i class="fas fa-info-circle"></i> ${o.adminNote}</p>` : ''}
                </div>
                `;
            }).join('') || '<p class="text-gray-400 text-sm">無訂單記錄</p>';

            renderChat();
        }

        function renderChat() {
            const allMsgs = JSON.parse(localStorage.getItem(DB_KEYS.MESSAGES));
            const chatBox = document.getElementById('chat-box');
            const myMsgs = allMsgs.filter(m => m.from === currentUser.id || m.to === currentUser.id);

            chatBox.innerHTML = myMsgs.map(m => {
                const isMe = m.from === currentUser.id;
                return `
                <div class="flex ${isMe ? 'justify-end' : 'justify-start'}">
                    <div class="max-w-[80%] rounded p-2 text-sm ${isMe ? 'bg-blue-100' : 'bg-white border'}">
                        <p class="font-bold text-xs text-gray-500 mb-1">${m.from}</p>
                        <p>${m.content}</p>
                    </div>
                </div>
                `;
            }).join('');
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function sendMessage(role) {
            const input = document.getElementById('chat-input');
            const content = input.value.trim();
            if(!content) return;

            const msg = {
                from: currentUser.id,
                to: 'admin',
                content: content,
                time: new Date().toISOString()
            };

            addMessageToDB(msg);
            input.value = '';
            renderChat();
        }

        function addMessage(from, to, content) {
             const msg = { from, to, content, time: new Date().toISOString() };
             addMessageToDB(msg);
        }

        function addMessageToDB(msg) {
            const msgs = JSON.parse(localStorage.getItem(DB_KEYS.MESSAGES));
            msgs.push(msg);
            localStorage.setItem(DB_KEYS.MESSAGES, JSON.stringify(msgs));
        }

        function updatePassword() {
            const newPass = document.getElementById('new-password').value.trim();
            if(!newPass) return;
            
            const users = JSON.parse(localStorage.getItem(DB_KEYS.USERS));
            const idx = users.findIndex(u => u.id === currentUser.id);
            if(idx !== -1) {
                users[idx].pass = newPass;
                localStorage.setItem(DB_KEYS.USERS, JSON.stringify(users));
                currentUser.pass = newPass;
                sessionStorage.setItem(DB_KEYS.CURRENT_USER, JSON.stringify(currentUser));
                toast('密碼已更新', 'success');
                document.getElementById('new-password').value = '';
            }
        }

        // --- ADMIN SYSTEM ---
        function renderAdmin() {
            // Render Pending Orders
            const orders = JSON.parse(localStorage.getItem(DB_KEYS.ORDERS));
            const pending = orders.filter(o => o.status === 'pending');
            const confirmed = orders.filter(o => o.status === 'confirmed').sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));

            document.getElementById('admin-orders-pending').innerHTML = pending.map(o => `
                <div class="bg-white p-3 rounded shadow border-l-4 border-yellow-400">
                    <div class="flex justify-between">
                        <span class="font-bold text-sm">${o.oid}</span>
                        <span class="text-xs text-gray-500">${new Date(o.timestamp).toLocaleString()}</span>
                    </div>
                    <p class="text-sm">會員: ${o.uid}</p>
                    <p class="text-sm font-bold">目前總額: $${o.total}</p>
                    <button onclick="openOrderReview('${o.oid}')" class="mt-2 w-full bg-yellow-500 text-white text-sm py-1 rounded hover:bg-yellow-600">核對並調整</button>
                </div>
            `).join('') || '無待核對訂單';

            document.getElementById('admin-orders-confirmed').innerHTML = confirmed.map(o => `
                <div class="bg-white p-3 rounded shadow border-l-4 border-green-400">
                     <div class="flex justify-between">
                        <span class="font-bold text-sm">${o.oid}</span>
                        <span class="text-xs text-gray-500">${new Date(o.timestamp).toLocaleString()}</span>
                    </div>
                    <p class="text-sm">會員: ${o.uid} | 金額: $${o.total}</p>
                    <div class="mt-1 flex gap-2">
                        <input type="text" id="msg-input-${o.oid}" class="border rounded text-xs p-1 flex-grow" placeholder="給會員留言...">
                        <button onclick="adminReplyOrder('${o.oid}', '${o.uid}')" class="bg-blue-500 text-white text-xs px-2 rounded">發送</button>
                    </div>
                </div>
            `).join('');

            // Products
            renderAdminProducts();
            // Users
            renderAdminUsers();
            // Messages
            renderAdminMessages();
            // Ensure chat box is rendered if open
            if(adminChatTarget) renderAdminChatBox();
        }

        function checkAdminBadges() {
            // Simple check if there are unread system messages or pending users
            const users = JSON.parse(localStorage.getItem(DB_KEYS.USERS));
            const hasPending = users.some(u => u.status === 'pending');
            
            if(hasPending) {
                document.getElementById('admin-msg-badge').classList.remove('hide');
            } else {
                document.getElementById('admin-msg-badge').classList.add('hide');
            }
        }

        function switchAdminTab(tab, btn) {
            document.querySelectorAll('.admin-tab-content').forEach(el => el.classList.add('hide'));
            document.getElementById(`admin-content-${tab}`).classList.remove('hide');
            
            // UI tabs style
            btn.parentElement.querySelectorAll('button').forEach(b => {
                b.classList.remove('bg-gray-200');
                b.classList.add('bg-gray-100');
            });
            btn.classList.remove('bg-gray-100');
            btn.classList.add('bg-gray-200');
        }

        // Admin: Product Logic
        function renderAdminProducts() {
            const products = JSON.parse(localStorage.getItem(DB_KEYS.PRODUCTS));
            document.getElementById('admin-product-list').innerHTML = products.map(p => `
                <tr class="border-b">
                    <td class="p-3">${p.id}</td>
                    <td class="p-3"><img src="${p.img}" class="w-8 h-8 object-cover"></td>
                    <td class="p-3">${p.name}</td>
                    <td class="p-3">${p.category}</td>
                    <td class="p-3">$${p.price}</td>
                    <td class="p-3">
                        <button onclick="editProduct(${p.id})" class="text-blue-600 mr-2"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteProduct(${p.id})" class="text-red-600"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        function saveProduct() {
            const name = document.getElementById('prod-name').value;
            const price = document.getElementById('prod-price').value;
            const cat = document.getElementById('prod-cat').value;
            const img = document.getElementById('prod-img').value;

            if(!name || !price) return toast('請填寫完整', 'error');

            const products = JSON.parse(localStorage.getItem(DB_KEYS.PRODUCTS));
            
            if (editingProductId) {
                const idx = products.findIndex(p => p.id === editingProductId);
                if(idx !== -1) {
                    products[idx] = { ...products[idx], name, price: Number(price), category: cat, img };
                    toast('商品已更新', 'success');
                }
            } else {
                const newId = products.length > 0 ? Math.max(...products.map(p => p.id)) + 1 : 1;
                products.push({ id: newId, name, price: Number(price), category: cat, img });
                toast('商品已新增', 'success');
            }

            localStorage.setItem(DB_KEYS.PRODUCTS, JSON.stringify(products));
            resetProductForm();
            renderAdminProducts();
        }

        function editProduct(id) {
            const products = JSON.parse(localStorage.getItem(DB_KEYS.PRODUCTS));
            const p = products.find(i => i.id === id);
            if(p) {
                editingProductId = id;
                document.getElementById('prod-name').value = p.name;
                document.getElementById('prod-price').value = p.price;
                document.getElementById('prod-cat').value = p.category;
                document.getElementById('prod-img').value = p.img;
            }
        }

        function deleteProduct(id) {
            if(!confirm('確定刪除?')) return;
            let products = JSON.parse(localStorage.getItem(DB_KEYS.PRODUCTS));
            products = products.filter(p => p.id !== id);
            localStorage.setItem(DB_KEYS.PRODUCTS, JSON.stringify(products));
            renderAdminProducts();
        }

        function resetProductForm() {
            editingProductId = null;
            document.getElementById('prod-name').value = '';
            document.getElementById('prod-price').value = '';
            document.getElementById('prod-cat').value = '';
            document.getElementById('prod-img').value = '';
        }

        // Admin: Users
        function renderAdminUsers() {
            const users = JSON.parse(localStorage.getItem(DB_KEYS.USERS));
            document.getElementById('admin-user-list').innerHTML = users.map(u => `
                <tr class="border-b">
                    <td class="p-3">${u.id} <br><span class="text-xs text-gray-500">${u.name}</span></td>
                    <td class="p-3 text-xs">
                        ${u.gender === 'male' ? '男' : (u.gender === 'female' ? '女' : '其他')} / ${u.phone || '無電話'}
                        <br>${u.birthday || ''}
                    </td>
                    <td class="p-3">
                        <span class="px-2 py-1 text-xs rounded ${u.status === 'active' ? 'bg-green-100 text-green-700' : (u.status === 'pending' ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700')}">${u.status === 'pending' ? '待審核' : u.status}</span>
                    </td>
                    <td class="p-3">
                         <select onchange="updateUserLevel('${u.id}', this.value)" class="border rounded text-sm">
                            <option value="0" ${u.level === 0 ? 'selected' : ''}>一般</option>
                            <option value="1" ${u.level === 1 ? 'selected' : ''}>VIP</option>
                         </select>
                    </td>
                    <td class="p-3">
                        ${u.status === 'pending' ? `<button onclick="approveUser('${u.id}')" class="bg-green-500 text-white text-xs px-2 py-1 rounded">審核通過</button>` : ''}
                        <button onclick="resetUserPass('${u.id}')" class="text-xs bg-gray-200 px-2 py-1 rounded ml-1">重置密碼</button>
                    </td>
                </tr>
            `).join('');
        }

        function approveUser(uid) {
            const users = JSON.parse(localStorage.getItem(DB_KEYS.USERS));
            const user = users.find(u => u.id === uid);
            if(user) {
                user.status = 'active';
                localStorage.setItem(DB_KEYS.USERS, JSON.stringify(users));
                
                // Auto send welcome message
                addMessage('admin', uid, '您的帳號已審核通過，歡迎開始購物！');
                
                toast('會員已開通', 'success');
                renderAdminUsers();
                checkAdminBadges();
            }
        }

        function updateUserLevel(uid, lvl) {
            const users = JSON.parse(localStorage.getItem(DB_KEYS.USERS));
            const user = users.find(u => u.id === uid);
            if(user) {
                user.level = Number(lvl);
                localStorage.setItem(DB_KEYS.USERS, JSON.stringify(users));
                toast('會員等級已更新', 'success');
            }
        }
        
        function resetUserPass(uid) {
            const newPass = prompt(`請輸入 ${uid} 的新密碼:`);
            if(newPass) {
                const users = JSON.parse(localStorage.getItem(DB_KEYS.USERS));
                const user = users.find(u => u.id === uid);
                user.pass = newPass;
                localStorage.setItem(DB_KEYS.USERS, JSON.stringify(users));
                toast('密碼已修改', 'success');
            }
        }

        // Admin: Messages Logic
        function renderAdminMessages() {
            const msgs = JSON.parse(localStorage.getItem(DB_KEYS.MESSAGES));
            const users = JSON.parse(localStorage.getItem(DB_KEYS.USERS)).filter(u => u.role !== 'admin');
            
            const list = document.getElementById('admin-msg-list');
            list.innerHTML = users.map(u => {
                const userMsgs = msgs.filter(m => m.from === u.id || m.to === u.id);
                const lastMsg = userMsgs.length > 0 ? userMsgs[userMsgs.length - 1].content : '尚無訊息';
                const isPending = u.status === 'pending';
                // Highlight active user
                const isActive = adminChatTarget === u.id;
                
                return `
                <div onclick="openAdminChat('${u.id}')" class="p-3 border-b cursor-pointer hover:bg-gray-50 ${isActive ? 'bg-blue-50' : ''}">
                    <div class="flex justify-between items-center">
                        <span class="font-bold text-sm">${u.id} ${u.name}</span>
                        ${isPending ? '<span class="text-[10px] bg-yellow-400 text-white px-1 rounded">待審核</span>' : ''}
                    </div>
                    <p class="text-xs text-gray-500 truncate">${lastMsg}</p>
                </div>
                `;
            }).join('');
        }

        function openAdminChat(uid) {
            adminChatTarget = uid;
            renderAdminMessages(); // Update list highlight only
            renderAdminChatBox();  // Render chat content
        }

        function renderAdminChatBox() {
            if(!adminChatTarget) return;
            const uid = adminChatTarget;

            document.getElementById('admin-chat-header').innerText = `與 ${uid} 的對話`;
            document.getElementById('admin-chat-input').disabled = false;
            document.getElementById('admin-chat-send-btn').disabled = false;
            
            // Render Messages
            const msgs = JSON.parse(localStorage.getItem(DB_KEYS.MESSAGES));
            const chatMsgs = msgs.filter(m => m.from === uid || m.to === uid);
            
            const box = document.getElementById('admin-chat-box');
            box.innerHTML = chatMsgs.map(m => {
                const isAdmin = m.from === 'admin';
                return `
                <div class="flex ${isAdmin ? 'justify-end' : 'justify-start'}">
                    <div class="max-w-[80%] rounded p-2 text-sm ${isAdmin ? 'bg-blue-100' : 'bg-white border'}">
                         <p class="font-bold text-xs text-gray-500 mb-1">${isAdmin ? '管理員' : m.from}</p>
                        <p>${m.content}</p>
                        <p class="text-[10px] text-gray-400 text-right mt-1">${new Date(m.time).toLocaleString()}</p>
                    </div>
                </div>
                `;
            }).join('');
            box.scrollTop = box.scrollHeight;
        }

        function adminSendMsg() {
            if(!adminChatTarget) return;
            const input = document.getElementById('admin-chat-input');
            const text = input.value.trim();
            if(!text) return;
            
            addMessage('admin', adminChatTarget, text);
            input.value = '';
            // Only update chat box to avoid full re-render
            renderAdminChatBox();
            renderAdminMessages(); // Update last message preview in list
        }

        // Admin: Order Review Logic
        function openOrderReview(oid) {
            const orders = JSON.parse(localStorage.getItem(DB_KEYS.ORDERS));
            reviewingOrder = orders.find(o => o.oid === oid);
            if(!reviewingOrder) return;

            const list = document.getElementById('order-review-items');
            list.innerHTML = reviewingOrder.items.map((item, idx) => `
                <div class="flex justify-between items-center border-b pb-2">
                    <div>
                        <p class="font-bold text-sm">${item.name}</p>
                        <p class="text-xs text-gray-500">原單價: ${item.originalPrice} | 數量: ${item.qty}</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="text-xs">調整單價:</label>
                        <input type="number" value="${item.finalPrice}" 
                            onchange="updateOrderItemPrice('${oid}', ${idx}, this.value)" 
                            class="w-20 border rounded p-1 text-sm text-right">
                    </div>
                </div>
            `).join('');

            document.getElementById('review-original-total').innerText = reviewingOrder.total;
            document.getElementById('review-final-total').innerText = reviewingOrder.total;
            document.getElementById('review-msg').value = `親愛的會員，您的訂單 ${oid} 已確認。\n品項價格已核對。\n\n請匯款至：\n銀行代號：000\n帳號：1234-5678-9000\n金額：$${reviewingOrder.total}\n\n匯款後請通知我們，謝謝！`;
            
            document.getElementById('modal-order-review').classList.remove('hide');
        }

        function updateOrderItemPrice(oid, idx, newPrice) {
            newPrice = Number(newPrice);
            if (reviewingOrder && reviewingOrder.oid === oid) {
                reviewingOrder.items[idx].finalPrice = newPrice;
                // Recalculate total
                reviewingOrder.total = reviewingOrder.items.reduce((acc, i) => acc + (i.finalPrice * i.qty), 0);
                document.getElementById('review-final-total').innerText = reviewingOrder.total;
            }
        }

        function confirmOrderAction() {
            if(!reviewingOrder) return;
            
            const orders = JSON.parse(localStorage.getItem(DB_KEYS.ORDERS));
            const idx = orders.findIndex(o => o.oid === reviewingOrder.oid);
            if(idx !== -1) {
                // Update Order in DB
                const msg = document.getElementById('review-msg').value;
                orders[idx] = reviewingOrder;
                orders[idx].status = 'confirmed';
                orders[idx].adminNote = msg; // Store the confirmation note
                
                localStorage.setItem(DB_KEYS.ORDERS, JSON.stringify(orders));
                
                // Send Message
                addMessage('admin', reviewingOrder.uid, msg);

                toast('訂單已確認並通知會員', 'success');
                closeModal('modal-order-review');
                renderAdmin();
                reviewingOrder = null;
            }
        }

        function adminReplyOrder(oid, uid) {
            const input = document.getElementById(`msg-input-${oid}`);
            const text = input.value.trim();
            if(text) {
                addMessage('admin', uid, `[訂單 ${oid}] ${text}`);
                input.value = '';
                toast('訊息已發送', 'success');
            }
        }

        // --- EXPORT / IMPORT ---
        function exportData() {
            const data = {
                users: JSON.parse(localStorage.getItem(DB_KEYS.USERS)),
                products: JSON.parse(localStorage.getItem(DB_KEYS.PRODUCTS)),
                orders: JSON.parse(localStorage.getItem(DB_KEYS.ORDERS)),
                messages: JSON.parse(localStorage.getItem(DB_KEYS.MESSAGES))
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], {type : 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `jcmarket_backup_${Date.now()}.json`;
            a.click();
        }

        function importData(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if(data.users) localStorage.setItem(DB_KEYS.USERS, JSON.stringify(data.users));
                    if(data.products) localStorage.setItem(DB_KEYS.PRODUCTS, JSON.stringify(data.products));
                    if(data.orders) localStorage.setItem(DB_KEYS.ORDERS, JSON.stringify(data.orders));
                    if(data.messages) localStorage.setItem(DB_KEYS.MESSAGES, JSON.stringify(data.messages));
                    alert('資料匯入成功，即將重新整理');
                    location.reload();
                } catch(err) {
                    alert('資料格式錯誤');
                }
            };
            reader.readAsText(file);
        }

        // --- UTILS ---
        function toast(msg, type='info') {
            const container = document.getElementById('toast-container');
            const el = document.createElement('div');
            const colors = { error: 'bg-red-500', success: 'bg-green-500', warning: 'bg-yellow-500', info: 'bg-blue-500' };
            el.className = `${colors[type]} text-white px-4 py-2 rounded shadow-lg transform transition-all duration-500 translate-x-full opacity-0`;
            el.innerText = msg;
            container.appendChild(el);
            
            // Animation
            setTimeout(() => { el.classList.remove('translate-x-full', 'opacity-0'); }, 10);
            setTimeout(() => { 
                el.classList.add('opacity-0'); 
                setTimeout(() => el.remove(), 500); 
            }, 3000);
        }

    </script>
</body>
</html>