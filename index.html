<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JCmarket è³¼ç‰©ç¶²</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Custom Styles */
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; }
        .hide { display: none !important; }
        .modal { background-color: rgba(0,0,0,0.5); }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Product Card Hover Effect */
        .product-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        
        /* Badge Pulse Animation */
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 6px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .badge-pulse { animation: pulse-red 2s infinite; }

        /* Print Styles (Hidden on Screen) */
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background-color: white; }
            .page-break { page-break-after: always; }
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Notifications Container -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 flex flex-col gap-2 no-print"></div>

    <!-- LOGIN PAGE -->
    <section id="page-login" class="min-h-screen flex items-center justify-center bg-blue-50 no-print">
        <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-md border-t-4 border-blue-600">
            <h1 class="text-4xl font-bold text-center mb-2 tracking-tight">
                <span class="text-blue-700">J</span><span class="text-orange-500">C</span><span class="text-gray-700 text-2xl">market</span>
            </h1>
            <p class="text-center text-gray-500 mb-6">è³¼ç‰©ç¶²ç«™ç™»å…¥ç³»çµ±</p>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">å¸³è™Ÿ (èº«åˆ†è­‰å­—è™Ÿ)</label>
                    <input type="text" id="login-username" placeholder="ä¾‹ï¼šA123456789 (é¦–å­—å¤§å¯«è‹±æ–‡)" class="mt-1 block w-full border border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">å¯†ç¢¼</label>
                    <input type="password" id="login-password" 
                           onkeydown="if(event.key === 'Enter') handleLogin()"
                           placeholder="èº«åˆ†è­‰å¾Œ4ç¢¼+ç”Ÿæ—¥(YYMMDD) å…±10ç¢¼" 
                           class="mt-1 block w-full border border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <button onclick="handleLogin()" class="w-full bg-orange-500 text-white py-2 rounded-md hover:bg-orange-600 transition font-bold shadow">ç™»å…¥ / è¨»å†Š</button>
            </div>
            
            <div class="mt-4 text-xs text-gray-500 bg-gray-100 p-3 rounded">
                <p><strong>é¦–æ¬¡ç™»å…¥èªªæ˜ï¼š</strong></p>
                <p>è«‹è¼¸å…¥æ‚¨çš„èº«åˆ†è­‰å­—è™Ÿä½œç‚ºå¸³è™Ÿã€‚</p>
                <p>å¯†ç¢¼è¦å‰‡ï¼šèº«åˆ†è­‰å¾Œ4ç¢¼ + ç”Ÿæ—¥è¥¿å…ƒå¹´æœ«å…©ç¢¼æœˆå…©ç¢¼æ—¥å…©ç¢¼ (å…±10ç¢¼)ã€‚</p>
                <p>ä¾‹å¦‚ï¼šèº«åˆ†è­‰ A12345<strong>6789</strong>ï¼Œç”Ÿæ—¥ 1999/01/01 (990101)</p>
                <p>å¯†ç¢¼ç‚ºï¼š<strong>6789990101</strong></p>
                <p>é¦–æ¬¡è¼¸å…¥æ­£ç¢ºæ ¼å¼å¾Œï¼Œç³»çµ±å°‡å¼•å°æ‚¨å¡«å¯«åŸºæœ¬è³‡æ–™ã€‚</p>
            </div>
        </div>
    </section>

    <!-- REGISTER PAGE -->
    <section id="view-register" class="hide min-h-screen flex items-center justify-center bg-blue-50 no-print">
        <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-md border-t-4 border-orange-500">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">æœƒå“¡è³‡æ–™å¡«å¯«</h2>
            <p class="text-sm text-gray-500 mb-4 text-center">è«‹å®ŒæˆåŸºæœ¬è³‡æ–™ä»¥é€å‡ºå¯©æ ¸</p>
            
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">å¸³è™Ÿ (å”¯è®€)</label>
                        <input type="text" id="reg-id" class="mt-1 block w-full bg-gray-100 border border-gray-300 rounded-md p-2 text-gray-500 cursor-not-allowed" readonly>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">ç”Ÿæ—¥ (å¹´ä»½å¯é¸)</label>
                        <div class="flex mt-1 shadow-sm rounded-md">
                            <select id="reg-birth-prefix" class="rounded-l-md border border-r-0 border-gray-300 bg-gray-50 text-gray-700 sm:text-sm p-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="19">19</option>
                                <option value="20">20</option>
                            </select>
                            <input type="text" id="reg-birth-suffix" class="flex-1 min-w-0 block w-full rounded-r-md border border-gray-300 bg-gray-100 text-gray-500 sm:text-sm p-2 cursor-not-allowed text-center" readonly>
                        </div>
                    </div>
                </div>
                <p class="text-xs text-gray-500 -mt-2">* å¹´ä»½å¾Œå…©ç¢¼åŠæ—¥æœŸä¾æ“šæ‚¨çš„å¯†ç¢¼è‡ªå‹•å¸¶å…¥ï¼Œä¸å¯ä¿®æ”¹ã€‚</p>

                <div>
                    <label class="block text-sm font-medium text-gray-700">çœŸå¯¦å§“å <span class="text-red-500">*</span></label>
                    <input type="text" id="reg-name" placeholder="è«‹è¼¸å…¥å§“å" class="mt-1 block w-full border border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700">æ€§åˆ¥ <span class="text-red-500">*</span></label>
                    <select id="reg-gender" class="mt-1 block w-full border border-gray-300 rounded-md p-2 bg-white">
                        <option value="male">ç”·</option>
                        <option value="female">å¥³</option>
                        <option value="other">å…¶ä»–</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700">è¯çµ¡é›»è©± <span class="text-red-500">*</span></label>
                    <input type="tel" id="reg-phone" placeholder="ä¾‹ï¼š0912345678" class="mt-1 block w-full border border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <button onclick="submitRegistration()" class="w-full bg-green-600 text-white py-2 rounded-md hover:bg-green-700 transition shadow">é€å‡ºç”³è«‹</button>
                <button onclick="cancelRegistration()" class="w-full bg-gray-300 text-gray-700 py-2 rounded-md hover:bg-gray-400 transition">å–æ¶ˆè¿”å›</button>
            </div>
        </div>
    </section>

    <!-- MAIN APP LAYOUT (Header + Content) -->
    <div id="app-layout" class="hide min-h-screen flex flex-col no-print">
        
        <!-- Header -->
        <header class="bg-white shadow-md sticky top-0 z-40 border-b-4 border-blue-600">
            <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <h1 class="text-2xl font-bold cursor-pointer flex items-center" onclick="router('shop')">
                        <span class="text-blue-700 text-3xl mr-1">J</span>
                        <span class="text-orange-500 text-3xl mr-1">C</span>
                        <span class="text-gray-700">market</span>
                    </h1>
                    <span id="nav-welcome" class="text-sm bg-gray-100 text-gray-600 px-3 py-1 rounded-full border">æ­¡è¿, æœƒå“¡</span>
                </div>
                
                <nav class="flex items-center gap-4">
                    <!-- User Nav -->
                    <div id="nav-user" class="flex items-center gap-4">
                        <button onclick="router('shop')" class="text-gray-600 hover:text-blue-600 transition"><i class="fas fa-home"></i> é¦–é </button>
                        <button onclick="router('cart')" class="text-gray-600 hover:text-blue-600 transition relative">
                            <i class="fas fa-shopping-cart"></i> è³¼ç‰©è»Š
                            <span id="cart-count" class="absolute -top-2 -right-2 bg-orange-500 text-white text-xs font-bold px-1.5 rounded-full">0</span>
                        </button>
                        <button onclick="router('profile')" class="text-gray-600 hover:text-blue-600 transition relative">
                            <i class="fas fa-user"></i> æœƒå“¡ä¸­å¿ƒ
                            <span id="member-badge" class="hide absolute -top-1 -right-1 w-2 h-2 bg-red-500 rounded-full border border-white badge-pulse"></span>
                        </button>
                    </div>

                    <!-- Admin Switch -->
                    <button id="btn-admin-switch" onclick="router('admin')" class="hide bg-gray-800 text-white px-3 py-1 rounded hover:bg-gray-700 text-sm border border-gray-600 shadow-sm relative">
                        <i class="fas fa-cogs"></i> å›åˆ°å¾Œå°
                        <span id="admin-global-badge" class="hide absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full border border-gray-800"></span>
                    </button>

                    <button onclick="logout()" class="text-sm text-gray-500 border border-gray-300 px-3 py-1 rounded hover:bg-gray-100 hover:text-red-500 transition">ç™»å‡º</button>
                </nav>
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="flex-grow container mx-auto px-4 py-6">
            
            <!-- SHOP VIEW -->
            <section id="view-shop" class="hide">
                <!-- Categories -->
                <div class="flex gap-2 overflow-x-auto pb-4 mb-4 scrollbar-hide" id="category-list"></div>
                <!-- Product Grid -->
                <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4" id="product-grid"></div>
            </section>

            <!-- CART VIEW -->
            <section id="view-cart" class="hide max-w-4xl mx-auto">
                <h2 class="text-2xl font-bold mb-4 border-b pb-2 text-gray-800">è³¼ç‰©è»Š</h2>
                <div id="cart-items" class="bg-white rounded shadow p-4 mb-4"></div>
                <div class="bg-white rounded shadow p-4 text-right">
                    <p class="text-xl font-bold text-orange-600">å•†å“å°è¨ˆ: $<span id="cart-subtotal">0</span></p>
                    <button onclick="openCheckoutModal()" class="mt-4 bg-orange-500 text-white px-8 py-2 rounded hover:bg-orange-600 font-bold shadow-lg transition transform hover:scale-105">å»è²·å–® (é¸æ“‡é…é€)</button>
                </div>
            </section>

            <!-- PROFILE VIEW -->
            <section id="view-profile" class="hide max-w-6xl mx-auto">
                <!-- Notifications Area (New) -->
                <div id="profile-notifications" class="mb-4"></div>

                <div class="grid md:grid-cols-5 gap-6">
                    <!-- Info (Editable) -->
                    <div class="md:col-span-2 bg-white p-4 rounded shadow h-fit">
                        <div class="flex justify-between items-center mb-4 border-b pb-2">
                            <h3 class="font-bold text-lg text-gray-800">æœƒå“¡è³‡æ–™</h3>
                            <span id="profile-level-badge" class="text-xs px-2 py-1 rounded bg-gray-200"></span>
                        </div>
                        
                        <div class="space-y-3">
                            <div>
                                <label class="block text-xs font-bold text-gray-500">å¸³è™Ÿ</label>
                                <input type="text" id="profile-id" class="w-full bg-gray-100 border p-2 rounded text-sm text-gray-500 cursor-not-allowed" readonly>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500">å§“å</label>
                                <input type="text" id="profile-name" class="w-full border p-2 rounded text-sm focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500">è¯çµ¡é›»è©±</label>
                                <input type="tel" id="profile-phone" class="w-full border p-2 rounded text-sm focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            
                            <div class="bg-blue-50 p-3 rounded border border-blue-100">
                                <label class="block text-xs font-bold text-gray-600 mb-2">é è¨­æ”¶ä»¶åœ°å€</label>
                                <div class="flex gap-2 mb-2">
                                    <input type="text" id="profile-zip" placeholder="éƒµéå€è™Ÿ(6ç¢¼)" class="w-1/3 border p-2 rounded text-sm bg-white">
                                    <select id="profile-city" class="w-1/3 border p-2 rounded text-sm bg-white"></select>
                                    <select id="profile-dist" class="w-1/3 border p-2 rounded text-sm bg-white"></select>
                                </div>
                                <input type="text" id="profile-addr-detail" placeholder="è¡—é“å··å¼„..." class="w-full border p-2 rounded text-sm bg-white">
                            </div>
                            
                            <button onclick="saveUserProfile()" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 transition mt-2 shadow">å„²å­˜è³‡æ–™</button>
                        </div>
                    </div>
                    
                    <!-- Orders & Messages -->
                    <div class="md:col-span-3 bg-white p-4 rounded shadow flex flex-col h-[600px]">
                        <h3 class="font-bold text-lg mb-4 border-b pb-2 text-gray-800">è¨Šæ¯èˆ‡è¨‚å–®</h3>
                        <div class="flex-grow border rounded p-3 mb-3 bg-gray-50 overflow-y-auto flex flex-col gap-2" id="chat-box"></div>
                        <div class="flex gap-2 mb-6">
                            <input type="text" id="chat-input" class="flex-grow border p-2 rounded" placeholder="å‚³é€è¨Šæ¯çµ¦ç®¡ç†å“¡...">
                            <button onclick="sendMessage('user')" class="bg-blue-600 text-white px-4 rounded hover:bg-blue-700 transition">å‚³é€</button>
                        </div>
                        <h4 class="font-bold text-sm text-gray-600 mb-2">æœ€è¿‘è¨‚å–®è¨˜éŒ„</h4>
                        <div id="profile-orders" class="space-y-2 overflow-y-auto h-48 border-t pt-2"></div>
                    </div>
                </div>
            </section>

            <!-- ADMIN DASHBOARD -->
            <section id="view-admin" class="hide">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">å¾Œå°ç®¡ç†ç³»çµ±</h2>
                    <div class="space-x-2 flex items-center">
                         <button onclick="router('shop')" class="bg-indigo-600 text-white px-4 py-2 rounded text-sm hover:bg-indigo-700 shadow flex items-center gap-2">
                             <i class="fas fa-store"></i> åˆ‡æ›è‡³å‰å°è³¼ç‰©
                         </button>
                         <span class="text-gray-300">|</span>
                         <button onclick="exportData()" class="bg-green-600 text-white px-3 py-1 rounded text-sm"><i class="fas fa-download"></i> åŒ¯å‡º</button>
                         <button onclick="document.getElementById('import-file').click()" class="bg-blue-600 text-white px-3 py-1 rounded text-sm"><i class="fas fa-upload"></i> åŒ¯å…¥</button>
                         <input type="file" id="import-file" class="hidden" onchange="importData(this)">
                    </div>
                </div>

                <!-- Admin Tabs -->
                <div class="flex gap-1 mb-4 border-b overflow-x-auto">
                    <button class="px-4 py-2 bg-gray-200 rounded-t active-tab whitespace-nowrap relative" onclick="switchAdminTab('orders', this)">
                        è¨‚å–®ç®¡ç† <span id="badge-admin-orders" class="hide absolute top-0 right-0 -mt-1 -mr-1 min-w-[1.25rem] h-5 bg-red-500 text-white text-[10px] font-bold flex items-center justify-center rounded-full shadow badge-pulse px-1">0</span>
                    </button>
                    <button class="px-4 py-2 bg-gray-100 rounded-t whitespace-nowrap" onclick="switchAdminTab('products', this)">å•†å“ç®¡ç†</button>
                    <button class="px-4 py-2 bg-gray-100 rounded-t whitespace-nowrap relative" onclick="switchAdminTab('users', this)">
                        æœƒå“¡ç®¡ç† <span id="badge-admin-users" class="hide absolute top-0 right-0 -mt-1 -mr-1 min-w-[1.25rem] h-5 bg-red-500 text-white text-[10px] font-bold flex items-center justify-center rounded-full shadow badge-pulse px-1">0</span>
                    </button>
                    <button class="px-4 py-2 bg-gray-100 rounded-t whitespace-nowrap relative" onclick="switchAdminTab('messages', this)">
                        è¨Šæ¯ä¸­å¿ƒ <span id="badge-admin-msgs" class="hide absolute top-0 right-0 -mt-1 -mr-1 w-3 h-3 bg-red-500 rounded-full badge-pulse"></span>
                    </button>
                </div>

                <!-- Admin Content -->
                <div id="admin-content-orders" class="admin-tab-content">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <div class="bg-yellow-100 border-l-4 border-yellow-500 p-2 mb-3 flex justify-between items-center">
                                <h3 class="font-bold text-yellow-700"><i class="fas fa-exclamation-circle"></i> å¾…æ ¸å°è¨‚å–®</h3>
                                <span id="count-orders-pending" class="bg-white text-yellow-700 px-2 py-0.5 rounded text-xs font-bold shadow">0</span>
                            </div>
                            <div id="admin-orders-pending" class="space-y-3"></div>
                        </div>
                        <div>
                            <div class="bg-green-100 border-l-4 border-green-500 p-2 mb-3 flex justify-between items-center">
                                <h3 class="font-bold text-green-700"><i class="fas fa-check-circle"></i> å·²æˆç«‹è¨‚å–®</h3>
                                <div>
                                    <button onclick="printSelectedOrders()" class="bg-gray-700 text-white px-2 py-1 rounded text-xs mr-2 hover:bg-gray-800 transition"><i class="fas fa-print"></i> æ‰¹æ¬¡åˆ—å°</button>
                                    <span id="count-orders-confirmed" class="bg-white text-green-700 px-2 py-0.5 rounded text-xs font-bold shadow">0</span>
                                </div>
                            </div>
                            <div id="admin-orders-confirmed" class="space-y-3"></div>
                        </div>
                    </div>
                </div>

                <div id="admin-content-products" class="admin-tab-content hide">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-bold text-gray-700">å•†å“åˆ—è¡¨</h3>
                        <button onclick="openAdminProductModal()" class="bg-purple-600 text-white px-4 py-2 rounded text-sm flex items-center gap-2 hover:bg-purple-700 shadow transition">
                             <i class="fas fa-plus"></i> æ–°å¢å•†å“
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full bg-white shadow rounded text-sm text-left">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="p-3">ID</th>
                                    <th class="p-3">åœ–ç‰‡</th>
                                    <th class="p-3">åç¨±</th>
                                    <th class="p-3">åˆ†é¡</th>
                                    <th class="p-3">é€²åƒ¹</th>
                                    <th class="p-3">å”®åƒ¹</th>
                                    <th class="p-3">åˆ©æ½¤</th>
                                    <th class="p-3">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="admin-product-list"></tbody>
                        </table>
                    </div>
                </div>

                <div id="admin-content-users" class="admin-tab-content hide">
                    <!-- Pending Users Section (High Priority) -->
                    <div id="admin-users-pending-container" class="mb-6 hide">
                        <h3 class="font-bold text-lg text-red-600 mb-2 border-b-2 border-red-200 pb-1">
                            <i class="fas fa-bell badge-pulse"></i> å¾…å¯©æ ¸ç”³è«‹ (è«‹ç›¡é€Ÿè™•ç†)
                        </h3>
                        <div class="bg-red-50 rounded border border-red-200 overflow-hidden">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-red-100 text-red-800">
                                    <tr>
                                        <th class="p-3">æœƒå“¡è³‡æ–™ (å§“å/å¸³è™Ÿ)</th>
                                        <th class="p-3">è©³ç´°è³‡è¨Š</th>
                                        <th class="p-3 w-48">å¯©æ ¸æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="admin-user-list-pending"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- All Users -->
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-bold text-gray-700">æ­£å¼æœƒå“¡åˆ—è¡¨</h3>
                        <button onclick="openAdminUserModal()" class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700 transition"><i class="fas fa-user-plus"></i> æ–°å¢æœƒå“¡</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full bg-white shadow rounded text-sm text-left">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="p-3">æœƒå“¡è³‡æ–™ (å§“å/å¸³è™Ÿ)</th>
                                    <th class="p-3">è©³ç´°è³‡è¨Š</th>
                                    <th class="p-3">ç‹€æ…‹</th>
                                    <th class="p-3">ç­‰ç´š</th>
                                    <th class="p-3">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="admin-user-list-active"></tbody>
                        </table>
                    </div>
                </div>

                <div id="admin-content-messages" class="admin-tab-content hide">
                    <div class="grid md:grid-cols-3 gap-4 h-[600px]">
                        <div class="md:col-span-1 bg-white shadow rounded overflow-y-auto" id="admin-msg-list"></div>
                        <div class="md:col-span-2 bg-white shadow rounded flex flex-col">
                            <div id="admin-chat-header" class="p-3 border-b font-bold bg-gray-50">è«‹é¸æ“‡å°è©±</div>
                            <div id="admin-chat-box" class="flex-grow p-4 overflow-y-auto bg-gray-50 space-y-3"></div>
                            <div class="p-3 border-t flex gap-2">
                                <input type="text" id="admin-chat-input" class="flex-grow border rounded p-2" placeholder="è¼¸å…¥å›è¦†..." disabled>
                                <button onclick="adminSendMsg()" id="admin-chat-send-btn" class="bg-blue-600 text-white px-4 rounded disabled:bg-gray-400 hover:bg-blue-700 transition" disabled>ç™¼é€</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- MODALS -->
    
    <!-- Register Success Modal (New) -->
    <div id="modal-register-success" class="fixed inset-0 modal hide flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg w-full max-w-sm text-center relative border-t-4 border-green-500">
            <div class="mb-4 text-green-500 text-5xl">
                <i class="fas fa-check-circle"></i>
            </div>
            <h3 class="text-2xl font-bold mb-2 text-gray-800">ç”³è«‹å·²é€å‡ºï¼</h3>
            <p class="text-gray-600 mb-6">è«‹ç­‰å¾…ç®¡ç†å“¡å¯©æ ¸æ‚¨çš„å¸³è™Ÿã€‚</p>
            
            <div class="bg-orange-100 border-2 border-orange-300 p-4 rounded-lg mb-6">
                <h4 class="font-bold text-orange-600 text-lg mb-1">ğŸ‰ æ–°æœƒå“¡å°ˆå±¬å¥½ç¦® ğŸ‰</h4>
                <p class="font-bold text-gray-800 mb-3">ç²è´ˆ $100 å…ƒæŠ˜åƒ¹åˆ¸</p>
                <p class="text-sm text-gray-600 mb-2">åŠ å…¥å®˜æ–¹ LINE å¥½å‹é ˜å–ï¼š</p>
                <div class="flex justify-center">
                    <a href="https://lin.ee/1TTrkju" target="_blank"><img src="https://scdn.line-apps.com/n/line_add_friends/btn/zh-Hant.png" alt="åŠ å…¥å¥½å‹" height="36" border="0"></a>
                </div>
            </div>

            <button onclick="finishRegistration()" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 transition">è¿”å›ç™»å…¥é é¢</button>
        </div>
    </div>

    <!-- Checkout Modal -->
    <div id="modal-checkout" class="fixed inset-0 modal hide flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg w-full max-w-lg max-h-[90vh] overflow-y-auto border-t-4 border-orange-500">
            <h3 class="text-xl font-bold mb-4 border-b pb-2">çµå¸³èˆ‡é…é€</h3>
            <div class="mb-4">
                <label class="block text-sm font-bold mb-2">é¸æ“‡é…é€æ–¹å¼</label>
                <div class="flex gap-4">
                    <label class="flex items-center gap-2 cursor-pointer p-2 border rounded hover:bg-orange-50 transition">
                        <input type="radio" name="deliveryType" value="pickup" onchange="toggleDeliveryMethod('pickup')" checked>
                        <span>åˆ°åº—è‡ªå–</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer p-2 border rounded hover:bg-orange-50 transition">
                        <input type="radio" name="deliveryType" value="delivery" onchange="toggleDeliveryMethod('delivery')">
                        <span>å®…é… (æ»¿$3000å…é‹)</span>
                    </label>
                </div>
            </div>
            <div id="opt-pickup" class="space-y-3 mb-4 bg-gray-50 p-3 rounded border">
                <div>
                    <label class="block text-sm font-bold mb-1">è‡ªå–æ—¥æœŸ</label>
                    <input type="date" id="checkout-date" class="w-full border p-2 rounded text-sm">
                </div>
                <div>
                    <label class="block text-sm font-bold mb-1">è‡ªå–æ™‚æ®µ</label>
                    <select id="checkout-time" class="w-full border p-2 rounded text-sm">
                        <option value="morning">ä¸Šåˆ (10:00 - 12:00)</option>
                        <option value="afternoon">ä¸‹åˆ (14:00 - 17:00)</option>
                        <option value="evening">æ™šä¸Š (18:00 - 20:00)</option>
                    </select>
                </div>
            </div>
            <div id="opt-delivery" class="hide space-y-3 mb-4 bg-gray-50 p-3 rounded border">
                <p class="text-sm text-gray-600 border-b pb-2 mb-2">å®…é…é‹è²»ï¼š$100 (æ»¿ $3000 å…é‹)</p>
                <div>
                    <label class="block text-sm font-bold mb-1">æ”¶ä»¶äººå§“å</label>
                    <input type="text" id="checkout-addr-name" class="w-full border p-2 rounded text-sm" placeholder="è«‹è¼¸å…¥å§“å">
                </div>
                <div>
                    <label class="block text-sm font-bold mb-1">æ”¶ä»¶åœ°å€</label>
                    <div class="flex gap-2 mb-2">
                        <input type="text" id="checkout-zip" placeholder="éƒµéå€è™Ÿ(6ç¢¼)" class="w-1/3 border p-2 rounded text-sm bg-white">
                        <select id="checkout-city" class="w-1/3 border p-2 rounded text-sm bg-white"></select>
                        <select id="checkout-dist" class="w-1/3 border p-2 rounded text-sm bg-white"></select>
                    </div>
                    <input type="text" id="checkout-addr-detail" class="w-full border p-2 rounded text-sm" placeholder="è¡—é“å··å¼„æ¨“å±¤...">
                </div>
                <div class="flex items-center gap-2 mt-2">
                    <input type="checkbox" id="save-as-default" class="cursor-pointer">
                    <label for="save-as-default" class="text-sm cursor-pointer select-none">åŒæ­¥æ›´æ–°è‡³æœƒå“¡é è¨­åœ°å€</label>
                </div>
            </div>
            <div class="border-t pt-3">
                <div class="flex justify-between text-sm mb-1">
                    <span>å•†å“å°è¨ˆ:</span>
                    <span>$<span id="checkout-subtotal">0</span></span>
                </div>
                <div class="flex justify-between text-sm mb-1 text-gray-600">
                    <span>é‹è²»:</span>
                    <span>$<span id="checkout-shipping">0</span></span>
                </div>
                <div class="flex justify-between font-bold text-xl text-orange-600 mt-2">
                    <span>ç¸½é‡‘é¡:</span>
                    <span>$<span id="checkout-total">0</span></span>
                </div>
            </div>
            <div class="flex justify-end gap-2 mt-6">
                <button onclick="closeModal('modal-checkout')" class="bg-gray-300 px-4 py-2 rounded hover:bg-gray-400">å–æ¶ˆ</button>
                <button onclick="confirmCheckout()" class="bg-orange-500 text-white px-6 py-2 rounded hover:bg-orange-600 shadow">ç¢ºèªä¸‹è¨‚</button>
            </div>
        </div>
    </div>

    <!-- Order Review Modal (Admin) -->
    <div id="modal-order-review" class="fixed inset-0 modal hide flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg w-full max-w-3xl max-h-[90vh] overflow-y-auto border-t-4 border-yellow-500">
            <h3 class="text-xl font-bold mb-4">è¨‚å–®æ ¸å° & å…§å®¹èª¿æ•´</h3>
            <div class="bg-blue-50 p-3 rounded mb-4 text-sm border border-blue-100">
                <p class="mb-1"><strong class="text-blue-800">æœƒå“¡è³‡æ–™ï¼š</strong><span id="review-member-info"></span></p>
                <p><strong class="text-blue-800">é…é€æ–¹å¼ï¼š</strong><span id="review-delivery-info"></span></p>
            </div>
            <table class="w-full text-sm text-left mb-4">
                <thead class="bg-gray-100 border-b">
                    <tr>
                        <th class="p-2">å•†å“</th>
                        <th class="p-2 w-20">æ•¸é‡</th>
                        <th class="p-2 w-24">å–®åƒ¹</th>
                        <th class="p-2 w-24">ç‹€æ…‹</th>
                    </tr>
                </thead>
                <tbody id="order-review-items"></tbody>
            </table>
            <div class="flex justify-end gap-4 bg-gray-100 p-3 rounded mb-4 text-sm">
                 <div>é‹è²»: $<span id="review-shipping-fee">0</span></div>
                 <div class="font-bold text-orange-600 text-lg">ç¸½é¡: $<span id="review-final-total">0</span></div>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-bold mb-1 text-gray-700">çµ¦æœƒå“¡çš„é€šçŸ¥è¨Šæ¯ (å°‡è‡ªå‹•ç™¼é€)</label>
                <textarea id="review-msg" class="w-full border p-2 rounded h-24 focus:ring-yellow-500 focus:border-yellow-500" placeholder="ä¾‹ï¼šå•†å“ç¢ºèªç„¡èª¤ï¼Œè«‹åŒ¯æ¬¾è‡³..."></textarea>
            </div>
            <div class="flex justify-end gap-2">
                <button onclick="closeModal('modal-order-review')" class="bg-gray-300 px-4 py-2 rounded hover:bg-gray-400">å–æ¶ˆ</button>
                <button id="btn-confirm-order" onclick="confirmOrderAction()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 shadow">ç¢ºèªè¨‚å–®ä¸¦é€šçŸ¥</button>
            </div>
        </div>
    </div>

    <!-- Admin Product Modal (New) -->
    <div id="modal-admin-product" class="fixed inset-0 modal hide flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg w-full max-w-lg">
            <h3 class="text-xl font-bold mb-4" id="modal-admin-prod-title">æ–°å¢å•†å“</h3>
            <div class="grid grid-cols-1 gap-3">
                <div>
                    <label class="block text-xs font-bold text-gray-600 mb-1">å•†å“åç¨±</label>
                    <input type="text" id="modal-prod-name" class="w-full border p-2 rounded text-sm">
                </div>
                <div class="grid grid-cols-2 gap-3">
                     <div>
                        <label class="block text-xs font-bold text-gray-600 mb-1">é€²åƒ¹ (æˆæœ¬)</label>
                        <input type="number" id="modal-prod-cost" class="w-full border p-2 rounded text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-600 mb-1">å”®åƒ¹</label>
                        <input type="number" id="modal-prod-price" class="w-full border p-2 rounded text-sm">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-bold text-gray-600 mb-1">åˆ†é¡</label>
                        <input type="text" id="modal-prod-cat" class="w-full border p-2 rounded text-sm" placeholder="ä¾‹: 3C">
                    </div>
                    <div>
                         <label class="block text-xs font-bold text-gray-600 mb-1">åœ–ç‰‡ç¶²å€</label>
                         <input type="text" id="modal-prod-img" class="w-full border p-2 rounded text-sm" placeholder="https://...">
                    </div>
                </div>
            </div>
            <div class="flex justify-end gap-2 mt-6">
                <button onclick="closeModal('modal-admin-product')" class="bg-gray-300 px-4 py-2 rounded">å–æ¶ˆ</button>
                <button onclick="saveProduct()" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">å„²å­˜</button>
            </div>
        </div>
    </div>

    <!-- Admin User Edit Modal -->
    <div id="modal-admin-user" class="fixed inset-0 modal hide flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg w-full max-w-lg">
            <h3 class="text-xl font-bold mb-4" id="modal-admin-user-title">æ–°å¢æœƒå“¡</h3>
            <div class="space-y-3">
                <div>
                    <label class="block text-xs font-bold text-gray-600">å¸³è™Ÿ (èº«åˆ†è­‰)</label>
                    <input type="text" id="adm-user-id" class="w-full border p-2 rounded text-sm">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-600">å¯†ç¢¼</label>
                    <input type="text" id="adm-user-pass" class="w-full border p-2 rounded text-sm" placeholder="é è¨­å¯†ç¢¼...">
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <label class="block text-xs font-bold text-gray-600">å§“å</label>
                        <input type="text" id="adm-user-name" class="w-full border p-2 rounded text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-600">é›»è©±</label>
                        <input type="text" id="adm-user-phone" class="w-full border p-2 rounded text-sm">
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-600">ç­‰ç´š</label>
                    <select id="adm-user-level" class="w-full border p-2 rounded text-sm">
                        <option value="0">ä¸€èˆ¬æœƒå“¡</option>
                        <option value="1">VIPæœƒå“¡</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-600">åœ°å€</label>
                    <div class="flex gap-2 mb-2">
                        <input type="text" id="adm-user-zip" placeholder="éƒµéå€è™Ÿ(6ç¢¼)" class="w-1/3 border p-2 rounded text-sm bg-white">
                        <select id="adm-user-city" class="w-1/3 border p-2 rounded text-sm bg-white"></select>
                        <select id="adm-user-dist" class="w-1/3 border p-2 rounded text-sm bg-white"></select>
                    </div>
                    <input type="text" id="adm-user-addr-detail" class="w-full border p-2 rounded text-sm" placeholder="è©³ç´°åœ°å€...">
                </div>
            </div>
            <div class="flex justify-end gap-2 mt-6">
                <button onclick="closeModal('modal-admin-user')" class="bg-gray-300 px-4 py-2 rounded">å–æ¶ˆ</button>
                <button onclick="saveAdminUser()" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">å„²å­˜</button>
            </div>
        </div>
    </div>

    <!-- Product Detail Modal -->
    <div id="modal-product" class="fixed inset-0 modal hide flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg w-full max-w-md relative">
            <button onclick="closeModal('modal-product')" class="absolute top-2 right-2 text-gray-500 hover:text-black"><i class="fas fa-times"></i></button>
            <img id="modal-p-img" src="" class="w-full h-48 object-cover rounded mb-4">
            <span id="modal-p-cat" class="text-xs bg-gray-200 px-2 py-1 rounded text-gray-600"></span>
            <h3 id="modal-p-name" class="text-xl font-bold mt-2"></h3>
            <div class="flex justify-between items-end mt-2 mb-4">
                <div>
                    <span class="text-gray-400 line-through text-sm">åŸåƒ¹ $<span id="modal-p-price"></span></span>
                    <br>
                    <span class="text-2xl font-bold text-orange-600">$<span id="modal-p-disc-price"></span></span>
                    <span class="text-xs text-red-500 ml-1" id="modal-p-discount-tag"></span>
                </div>
            </div>
            <button id="btn-add-to-cart" class="w-full bg-orange-500 text-white py-2 rounded hover:bg-orange-600 font-bold">åŠ å…¥è³¼ç‰©è»Š</button>
        </div>
    </div>

    <script>
        const DB_KEYS = {
            USERS: 'jc_users',
            PRODUCTS: 'jc_products',
            ORDERS: 'jc_orders',
            MESSAGES: 'jc_messages',
            CURRENT_USER: 'jc_current_user'
        };

        const TW_ZIPS = {
            "è‡ºåŒ—å¸‚": { "ä¸­æ­£å€": "100000", "å¤§åŒå€": "103000", "ä¸­å±±å€": "104000", "æ¾å±±å€": "105000", "å¤§å®‰å€": "106000", "è¬è¯å€": "108000", "ä¿¡ç¾©å€": "110000", "å£«æ—å€": "111000", "åŒ—æŠ•å€": "112000", "å…§æ¹–å€": "114000", "å—æ¸¯å€": "115000", "æ–‡å±±å€": "116000" },
            "æ–°åŒ—å¸‚": { "æ¿æ©‹å€": "220000", "ä¸‰é‡å€": "241000", "ä¸­å’Œå€": "235000", "æ°¸å’Œå€": "234000", "æ–°èŠå€": "242000", "æ–°åº—å€": "231000", "åœŸåŸå€": "236000", "è˜†æ´²å€": "247000", "æ±æ­¢å€": "221000", "æ¨¹æ—å€": "238000", "æ·¡æ°´å€": "251000", "ä¸‰å³½å€": "237000" },
            "æ¡ƒåœ’å¸‚": { "ä¸­å£¢å€": "320000", "å¹³é®å€": "324000", "é¾æ½­å€": "325000", "æ¥Šæ¢…å€": "326000", "æ–°å±‹å€": "327000", "è§€éŸ³å€": "328000", "æ¡ƒåœ’å€": "330000", "é¾œå±±å€": "333000", "å…«å¾·å€": "334000", "å¤§æºªå€": "335000" },
            "è‡ºä¸­å¸‚": { "ä¸­å€": "400000", "æ±å€": "401000", "å—å€": "402000", "è¥¿å€": "403000", "åŒ—å€": "404000", "åŒ—å±¯å€": "406000", "è¥¿å±¯å€": "407000", "å—å±¯å€": "408000", "å¤ªå¹³å€": "411000", "å¤§é‡Œå€": "412000", "éœ§å³°å€": "413000" },
            "è‡ºå—å¸‚": { "ä¸­è¥¿å€": "700000", "æ±å€": "701000", "å—å€": "702000", "åŒ—å€": "704000", "å®‰å¹³å€": "708000", "å®‰å—å€": "709000", "æ°¸åº·å€": "710000", "æ­¸ä»å€": "711000" },
            "é«˜é›„å¸‚": { "æ–°èˆˆå€": "800000", "å‰é‡‘å€": "801000", "è‹“é›…å€": "802000", "é¹½åŸ•å€": "803000", "é¼“å±±å€": "804000", "æ——æ´¥å€": "805000", "å‰é®å€": "806000", "ä¸‰æ°‘å€": "807000", "æ¥ æ¢“å€": "811000", "å°æ¸¯å€": "812000", "å·¦ç‡Ÿå€": "813000", "é³³å±±å€": "830000" },
            "æ–°ç«¹å¸‚": { "æ±å€": "300000", "åŒ—å€": "300000", "é¦™å±±å€": "300000" }
        };

        const initialProducts = [
            { id: 1, name: "Apple iPhone 15 Pro", price: 36900, cost: 34000, category: "3C", img: "https://placehold.co/400x400/333/FFF?text=iPhone+15" },
            { id: 2, name: "Dyson å¹é¢¨æ©Ÿ", price: 12900, cost: 10000, category: "å®¶é›»", img: "https://placehold.co/400x400/pink/FFF?text=Dyson" },
            { id: 3, name: "SK-II é’æ˜¥éœ²", price: 4500, cost: 3500, category: "ç¾å¦", img: "https://placehold.co/400x400/red/FFF?text=SK-II" },
            { id: 4, name: "Nike æ…¢è·‘é‹", price: 2800, cost: 1800, category: "é‹å‹•", img: "https://placehold.co/400x400/orange/FFF?text=Nike" },
            { id: 5, name: "Sony WH-1000XM5", price: 9900, cost: 8000, category: "3C", img: "https://placehold.co/400x400/black/FFF?text=Sony" },
            { id: 6, name: "è¡›ç”Ÿç´™ä¸€ç®±", price: 899, cost: 600, category: "æ—¥ç”¨", img: "https://placehold.co/400x400/white/333?text=Tissue" }
        ];

        let currentUser = null;
        let cart = [];
        let editingProductId = null;
        let reviewingOrder = null;
        let adminChatTarget = null; 
        let tempRegisterAuth = null; 
        let editingUserId = null; 
        
        const SHIPPING_THRESHOLD = 3000;
        const SHIPPING_FEE = 100;
        let currentDeliveryType = 'pickup';

        window.onload = function() {
            if(!localStorage.getItem(DB_KEYS.USERS)) {
                const admin = { id: 'admin', pass: 'admin', role: 'admin', name: 'ç®¡ç†å“¡', status: 'active', level: 1 };
                localStorage.setItem(DB_KEYS.USERS, JSON.stringify([admin]));
            }
            if(!localStorage.getItem(DB_KEYS.PRODUCTS)) {
                localStorage.setItem(DB_KEYS.PRODUCTS, JSON.stringify(initialProducts));
            }
            if(!localStorage.getItem(DB_KEYS.ORDERS)) localStorage.setItem(DB_KEYS.ORDERS, JSON.stringify([]));
            if(!localStorage.getItem(DB_KEYS.MESSAGES)) localStorage.setItem(DB_KEYS.MESSAGES, JSON.stringify([]));

            checkSession();
        };

        function checkSession() {
            const stored = sessionStorage.getItem(DB_KEYS.CURRENT_USER);
            if (stored) {
                currentUser = JSON.parse(stored);
                initApp();
            } else {
                document.getElementById('page-login').classList.remove('hide');
                document.getElementById('app-layout').classList.add('hide');
                document.getElementById('view-register').classList.add('hide');
            }
        }

        function handleLogin() {
            const userIn = document.getElementById('login-username').value.trim();
            const passIn = document.getElementById('login-password').value.trim();
            
            if(!userIn || !passIn) return toast('è«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼', 'error');

            const users = JSON.parse(localStorage.getItem(DB_KEYS.USERS));
            const user = users.find(u => u.id === userIn);

            if (user) {
                if (user.pass === passIn) {
                    if (user.status === 'pending') {
                        toast('å¸³è™Ÿå¯©æ ¸ä¸­ï¼Œè«‹ç­‰å¾…ç®¡ç†å“¡é€šçŸ¥', 'warning');
                        return;
                    }
                    loginSuccess(user);
                } else {
                    toast('å¯†ç¢¼éŒ¯èª¤', 'error');
                }
            } else {
                const idRegex = /^[A-Z][0-9]{9}$/;
                if (!idRegex.test(userIn)) return toast('å¸³è™Ÿæ ¼å¼éŒ¯èª¤ï¼Œè«‹è¼¸å…¥èº«åˆ†è­‰å­—è™Ÿ (é¦–å­—å¤§å¯«è‹±æ–‡)', 'error');

                const last4Id = userIn.slice(-4);
                const passRegex = new RegExp(`^${last4Id}\\d{6}$`);
                
                if (!passRegex.test(passIn)) {
                    return toast('é¦–æ¬¡ç™»å…¥å¯†ç¢¼æ ¼å¼éŒ¯èª¤ (èº«åˆ†è­‰å¾Œ4ç¢¼+ç”Ÿæ—¥6ç¢¼)', 'error');
                }

                tempRegisterAuth = { id: userIn, pass: passIn };
                
                const rawDate = passIn.slice(-6); 
                const yearYY = parseInt(rawDate.substring(0, 2));
                const currentYY = new Date().getFullYear() % 100; 
                const prefix = yearYY > currentYY ? '19' : '20';
                const suffixDate = `${rawDate.substring(0,2)}/${rawDate.substring(2,4)}/${rawDate.substring(4,6)}`;

                document.getElementById('reg-id').value = userIn;
                document.getElementById('reg-birth-prefix').value = prefix; 
                document.getElementById('reg-birth-suffix').value = suffixDate;
                
                document.getElementById('reg-name').value = '';
                document.getElementById('reg-phone').value = '';
                
                document.getElementById('page-login').classList.add('hide');
                document.getElementById('view-register').classList.remove('hide');
                
                toast('é©—è­‰æˆåŠŸï¼Œè«‹å¡«å¯«è©³ç´°è³‡æ–™ä»¥å®Œæˆè¨»å†Š', 'info');
            }
        }

        function submitRegistration() {
            try {
                const name = document.getElementById('reg-name').value.trim();
                const gender = document.getElementById('reg-gender').value;
                const phone = document.getElementById('reg-phone').value.trim();
                
                const birthPrefix = document.getElementById('reg-birth-prefix').value;
                const birthSuffix = document.getElementById('reg-birth-suffix').value; 
                const birthday = `${birthPrefix}${birthSuffix}`;

                if(!name || !phone) return toast('è«‹å¡«å¯«å®Œæ•´å§“åèˆ‡é›»è©±', 'error');
                if(!tempRegisterAuth) {
                    document.getElementById('view-register').classList.add('hide');
                    document.getElementById('page-login').classList.remove('hide');
                    return toast('é©—è­‰å¤±æ•ˆï¼Œè«‹é‡æ–°ç™»å…¥', 'error');
                }

                const users = JSON.parse(localStorage.getItem(DB_KEYS.USERS));
                if(users.some(u => u.id === tempRegisterAuth.id)) {
                    toast('æ­¤å¸³è™Ÿå·²å­˜åœ¨', 'error');
                    cancelRegistration();
                    return;
                }

                const newUser = {
                    id: tempRegisterAuth.id,
                    pass: tempRegisterAuth.pass,
                    role: 'user',
                    name: name,
                    gender: gender,
                    phone: phone,
                    birthday: birthday,
                    addressCity: '',
                    addressDist: '',
                    addressDetail: '',
                    status: 'pending',
                    level: 0, 
                    joined: new Date().toISOString()
                };
                
                users.push(newUser);
                localStorage.setItem(DB_KEYS.USERS, JSON.stringify(users));
                
                openRegisterSuccessModal();
            } catch (e) {
                console.error(e);
                toast('è¨»å†Šç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡è©¦', 'error');
                cancelRegistration();
            }
        }

        function openRegisterSuccessModal() {
            document.getElementById('modal-register-success').classList.remove('hide');
        }

        function finishRegistration() {
            document.getElementById('modal-register-success').classList.add('hide');
            tempRegisterAuth = null;
            document.getElementById('view-register').classList.add('hide');
            document.getElementById('page-login').classList.remove('hide');
            document.getElementById('login-username').value = '';
            document.getElementById('login-password').value = '';
        }

        function cancelRegistration() {
            tempRegisterAuth = null;
            document.getElementById('view-register').classList.add('hide');
            document.getElementById('page-login').classList.remove('hide');
        }

        function loginSuccess(user) {
            currentUser = user;
            sessionStorage.setItem(DB_KEYS.CURRENT_USER, JSON.stringify(user));
            document.getElementById('page-login').classList.add('hide');
            initApp();
            
            if(user.role === 'admin') {
                const orders = JSON.parse(localStorage.getItem(DB_KEYS.ORDERS));
                const pendingCount = orders.filter(o => o.status === 'pending').length;
                if(pendingCount > 0) {
                    setTimeout(() => alert(`æ­¡è¿ç®¡ç†å“¡ï¼ç›®å‰æœ‰ ${pendingCount} ç­†è¨‚å–®å¾…æ ¸å°ã€‚`), 500);
                }
            }
        }

        function logout() {
            currentUser = null;
            sessionStorage.removeItem(DB_KEYS.CURRENT_USER);
            document.getElementById('app-layout').classList.add('hide');
            document.getElementById('view-register').classList.add('hide');
            document.getElementById('page-login').classList.remove('hide');
            document.getElementById('login-username').value = '';
            document.getElementById('login-password').value = '';
            cart = [];
            adminChatTarget = null;
            toast('å·²ç™»å‡º', 'info');
        }

        function initAddressSelectors(cityId, distId, zipId, savedCity, savedDist) {
            const citySelect = document.getElementById(cityId);
            const distSelect = document.getElementById(distId);
            const zipInput = document.getElementById(zipId);

            citySelect.innerHTML = '<option value="">è«‹é¸æ“‡ç¸£å¸‚</option>';
            Object.keys(TW_ZIPS).forEach(city => {
                citySelect.innerHTML += `<option value="${city}" ${savedCity === city ? 'selected' : ''}>${city}</option>`;
            });

            const populateDistricts = (city) => {
                distSelect.innerHTML = '<option value="">è«‹é¸æ“‡å€åŸŸ</option>';
                if (city && TW_ZIPS[city]) {
                    Object.keys(TW_ZIPS[city]).forEach(dist => {
                        distSelect.innerHTML += `<option value="${dist}" ${savedDist === dist ? 'selected' : ''}>${dist}</option>`;
                    });
                    if(savedDist && TW_ZIPS[city][savedDist] && !zipInput.value) {
                        zipInput.value = TW_ZIPS[city][savedDist];
                    }
                }
            };

            if(savedCity) populateDistricts(savedCity);

            citySelect.onchange = (e) => populateDistricts(e.target.value);
            distSelect.onchange = (e) => {
                const city = citySelect.value;
                const dist = e.target.value;
                if(city && dist && TW_ZIPS[city][dist]) {
                    zipInput.value = TW_ZIPS[city][dist];
                }
            };
        }

        function initApp() {
            document.getElementById('app-layout').classList.remove('hide');
            document.getElementById('nav-welcome').innerText = `æ­¡è¿, ${currentUser.name}`;
            
            if (currentUser.role === 'admin') {
                document.getElementById('btn-admin-switch').classList.remove('hide');
                document.getElementById('nav-user').classList.add('hide'); 
                checkAdminBadges();
                router('admin');
            } else {
                document.getElementById('btn-admin-switch').classList.add('hide');
                document.getElementById('nav-user').classList.remove('hide');
                checkMemberBadges();
                router('shop');
            }

            renderShop();
            updateCartCount();
        }

        function router(viewName) {
            ['shop', 'cart', 'profile', 'admin'].forEach(v => document.getElementById(`view-${v}`).classList.add('hide'));
            document.getElementById(`view-${viewName}`).classList.remove('hide');

            if (viewName === 'shop') renderShop();
            if (viewName === 'cart') renderCart();
            if (viewName === 'profile') renderProfile();
            if (viewName === 'admin') {
                if(currentUser.role !== 'admin') {
                    toast('ç„¡æ¬Šé™', 'error');
                    router('shop');
                    return;
                }
                renderAdmin();
            }
        }

        function renderShop() {
            const products = JSON.parse(localStorage.getItem(DB_KEYS.PRODUCTS));
            const grid = document.getElementById('product-grid');
            const catList = document.getElementById('category-list');
            
            const categories = ['å…¨éƒ¨', ...new Set(products.map(p => p.category))];
            catList.innerHTML = categories.map(c => 
                `<button onclick="filterShop('${c}')" class="whitespace-nowrap px-4 py-1 rounded-full bg-white border hover:bg-pink-50">${c}</button>`
            ).join('');

            filterShop('å…¨éƒ¨');
        }

        function filterShop(cat) {
            const products = JSON.parse(localStorage.getItem(DB_KEYS.PRODUCTS));
            const grid = document.getElementById('product-grid');
            const filtered = cat === 'å…¨éƒ¨' ? products : products.filter(p => p.category === cat);
            
            grid.innerHTML = filtered.map(p => {
                const discount = getMemberDiscount();
                const finalPrice = Math.floor(p.price * discount);
                return `
                <div class="product-card bg-white p-4 rounded shadow cursor-pointer transition" onclick="openProductModal(${p.id})">
                    <img src="${p.img}" class="w-full h-40 object-cover rounded mb-2 bg-gray-200" onerror="this.src='https://placehold.co/400?text=No+Image'">
                    <span class="text-xs text-gray-500">${p.category}</span>
                    <h3 class="font-bold text-gray-800 text-sm h-10 overflow-hidden">${p.name}</h3>
                    <div class="mt-2 flex justify-between items-center">
                        <span class="font-bold text-pink-600">$${finalPrice}</span>
                        ${discount < 1 ? '<span class="text-xs bg-red-100 text-red-600 px-1 rounded">æœƒå“¡åƒ¹</span>' : ''}
                    </div>
                </div>
                `;
            }).join('');
        }

        function getMemberDiscount() {
            if (!currentUser) return 1;
            const level = currentUser.level || 0;
            if (level === 1) return 0.95;
            if (level >= 2) return 0.90;
            return 1;
        }

        function openProductModal(pid) {
            const products = JSON.parse(localStorage.getItem(DB_KEYS.PRODUCTS));
            const p = products.find(i => i.id === pid);
            if(!p) return;

            const discount = getMemberDiscount();
            const finalPrice = Math.floor(p.price * discount);

            document.getElementById('modal-p-img').src = p.img;
            document.getElementById('modal-p-cat').innerText = p.category;
            document.getElementById('modal-p-name').innerText = p.name;
            document.getElementById('modal-p-price').innerText = p.price;
            document.getElementById('modal-p-disc-price').innerText = finalPrice;
            document.getElementById('modal-p-discount-tag').innerText = discount < 1 ? `(æœƒå“¡å°ˆå±¬ ${discount*10}æŠ˜)` : '';
            
            const btn = document.getElementById('btn-add-to-cart');
            btn.onclick = () => addToCart(p);

            document.getElementById('modal-product').classList.remove('hide');
        }

        function closeModal(id) {
            document.getElementById(id).classList.add('hide');
        }

        function addToCart(product) {
            const discount = getMemberDiscount();
            const finalPrice = Math.floor(product.price * discount);
            
            const existing = cart.find(item => item.id === product.id);
            if(existing) {
                existing.qty++;
            } else {
                cart.push({ ...product, qty: 1, finalPrice: finalPrice, originalPrice: product.price });
            }
            
            updateCartCount();
            closeModal('modal-product');
            toast('å·²åŠ å…¥è³¼ç‰©è»Š', 'success');
        }

        function updateCartCount() {
            document.getElementById('cart-count').innerText = cart.reduce((acc, item) => acc + item.qty, 0);
        }

        function renderCart() {
            const container = document.getElementById('cart-items');
            if(cart.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-4">è³¼ç‰©è»Šæ˜¯ç©ºçš„</p>';
                document.getElementById('cart-subtotal').innerText = '0';
                return;
            }

            let total = 0;
            container.innerHTML = cart.map((item, idx) => {
                const subtotal = item.finalPrice * item.qty;
                total += subtotal;
                return `
                <div class="flex justify-between items-center border-b py-2">
                    <div class="flex items-center gap-2">
                        <img src="${item.img}" class="w-12 h-12 rounded object-cover">
                        <div>
                            <p class="font-bold text-sm">${item.name}</p>
                            <p class="text-xs text-gray-500">å–®åƒ¹ $${item.finalPrice}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <button onclick="updateCartQty(${idx}, -1)" class="bg-gray-200 w-6 h-6 rounded">-</button>
                        <span>${item.qty}</span>
                        <button onclick="updateCartQty(${idx}, 1)" class="bg-gray-200 w-6 h-6 rounded">+</button>
                    </div>
                </div>
                `;
            }).join('');
            document.getElementById('cart-subtotal').innerText = total;
        }

        function updateCartQty(idx, change) {
            cart[idx].qty += change;
            if(cart[idx].qty <= 0) cart.splice(idx, 1);
            renderCart();
            updateCartCount();
        }

        function openCheckoutModal() {
            if(cart.length === 0) return toast('è³¼ç‰©è»Šæ˜¯ç©ºçš„', 'error');
            
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('checkout-date').valueAsDate = tomorrow;
            
            if(currentUser) {
                document.getElementById('checkout-addr-name').value = currentUser.name;
                initAddressSelectors('checkout-city', 'checkout-dist', 'checkout-zip', currentUser.addressCity, currentUser.addressDist);
                document.getElementById('checkout-addr-detail').value = currentUser.addressDetail || '';
                if(currentUser.addressZip) document.getElementById('checkout-zip').value = currentUser.addressZip;
            } else {
                initAddressSelectors('checkout-city', 'checkout-dist', 'checkout-zip', '', '');
            }

            toggleDeliveryMethod('pickup');
            document.getElementById('modal-checkout').classList.remove('hide');
        }

        function toggleDeliveryMethod(type) {
            currentDeliveryType = type;
            const optPickup = document.getElementById('opt-pickup');
            const optDelivery = document.getElementById('opt-delivery');
            
            if(type === 'pickup') {
                optPickup.classList.remove('hide');
                optDelivery.classList.add('hide');
            } else {
                optPickup.classList.add('hide');
                optDelivery.classList.remove('hide');
            }
            calcCheckoutTotal();
        }

        function calcCheckoutTotal() {
            const subtotal = cart.reduce((acc, item) => acc + (item.finalPrice * item.qty), 0);
            let shipping = 0;

            if(currentDeliveryType === 'delivery') {
                if(subtotal < SHIPPING_THRESHOLD) {
                    shipping = SHIPPING_FEE;
                }
            }

            document.getElementById('checkout-subtotal').innerText = subtotal;
            document.getElementById('checkout-shipping').innerText = shipping;
            document.getElementById('checkout-total').innerText = subtotal + shipping;
            
            return { subtotal, shipping, total: subtotal + shipping };
        }

        function confirmCheckout() {
            const { subtotal, shipping, total } = calcCheckoutTotal();
            let deliveryInfo = {};

            if (currentDeliveryType === 'pickup') {
                const date = document.getElementById('checkout-date').value;
                const time = document.getElementById('checkout-time').options[document.getElementById('checkout-time').selectedIndex].text;
                if(!date) return toast('è«‹é¸æ“‡å–è²¨æ—¥æœŸ', 'error');
                deliveryInfo = { type: 'pickup', text: `åˆ°åº—è‡ªå– - ${date} ${time}`, date, time };
            } else {
                const name = document.getElementById('checkout-addr-name').value.trim();
                const city = document.getElementById('checkout-city').value;
                const dist = document.getElementById('checkout-dist').value;
                const zip = document.getElementById('checkout-zip').value;
                const detail = document.getElementById('checkout-addr-detail').value.trim();
                
                if(!name || !city || !dist || !detail) return toast('è«‹å¡«å¯«å®Œæ•´æ”¶ä»¶è³‡è¨Š', 'error');
                const fullAddr = `${zip} ${city}${dist}${detail}`;
                deliveryInfo = { type: 'delivery', text: `å®…é… - ${name} (${fullAddr})`, name, addr: fullAddr };

                const saveDefault = document.getElementById('save-as-default').checked;
                if (saveDefault && currentUser) {
                    const users = JSON.parse(localStorage.getItem(DB_KEYS.USERS));
                    const idx = users.findIndex(u => u.id === currentUser.id);
                    if (idx !== -1) {
                        users[idx].addressCity = city;
                        users[idx].addressDist = dist;
                        users[idx].addressDetail = detail;
                        users[idx].addressZip = zip; 
                        localStorage.setItem(DB_KEYS.USERS, JSON.stringify(users));
                        currentUser = users[idx];
                        sessionStorage.setItem(DB_KEYS.CURRENT_USER, JSON.stringify(currentUser));
                    }
                }
            }

            const orders = JSON.parse(localStorage.getItem(DB_KEYS.ORDERS));
            const newOrder = {
                oid: 'ORD-' + Date.now(),
                uid: currentUser.id,
                items: [...cart],
                subtotal: subtotal,
                shipping: shipping,
                total: total,
                delivery: deliveryInfo,
                status: 'pending', 
                timestamp: new Date().toISOString(),
                adminNote: ''
            };

            orders.push(newOrder);
            localStorage.setItem(DB_KEYS.ORDERS, JSON.stringify(orders));
            
            addMessage('system', 'admin', `æ–°è¨‚å–® ${newOrder.oid} (${deliveryInfo.type === 'pickup' ? 'è‡ªå–' : 'å®…é…'}) å¾…æ ¸å°`);

            cart = [];
            updateCartCount();
            closeModal('modal-checkout');
            router('profile');
            toast('è¨‚å–®å·²é€å‡ºï¼Œç­‰å¾…ç®¡ç†å“¡æ ¸å°', 'success');
        }

        function renderProfile() {
            document.getElementById('profile-id').value = currentUser.id;
            document.getElementById('profile-name').value = currentUser.name;
            document.getElementById('profile-phone').value = currentUser.phone || '';
            
            initAddressSelectors('profile-city', 'profile-dist', 'profile-zip', currentUser.addressCity, currentUser.addressDist);
            document.getElementById('profile-addr-detail').value = currentUser.addressDetail || '';
            if(currentUser.addressZip) document.getElementById('profile-zip').value = currentUser.addressZip;
            
            const levelBadge = document.getElementById('profile-level-badge');
            if (currentUser.level === 1) {
                levelBadge.innerHTML = '<i class="fas fa-crown text-yellow-600"></i> VIPæœƒå“¡';
                levelBadge.className = 'text-xs px-2 py-1 rounded bg-yellow-100 text-yellow-800 font-bold border border-yellow-300';
            } else {
                levelBadge.innerHTML = 'ä¸€èˆ¬æœƒå“¡';
                levelBadge.className = 'text-xs px-2 py-1 rounded bg-gray-100 text-gray-600';
            }

            const notificationBox = document.getElementById('profile-notifications');
            let alertsHtml = '';

            const orders = JSON.parse(localStorage.getItem(DB_KEYS.ORDERS));
            const confirmedOrders = orders.filter(o => o.uid === currentUser.id && o.status === 'confirmed');
            if (confirmedOrders.length > 0) {
                alertsHtml += `<div class="bg-green-100 border-l-4 border-green-500 text-green-700 p-3 mb-2 text-sm">
                    <p class="font-bold">è¨‚å–®é€šçŸ¥</p>
                    <p>æ‚¨æœ‰ ${confirmedOrders.length} ç­†è¨‚å–®å·²æˆç«‹ï¼Œè«‹æŸ¥çœ‹ä¸‹æ–¹è¨‚å–®è¨˜éŒ„ä¸¦é€²è¡Œå¾ŒçºŒä½œæ¥­ã€‚</p>
                </div>`;
            }

            const myMsgs = JSON.parse(localStorage.getItem(DB_KEYS.MESSAGES)).filter(m => m.to === currentUser.id || m.from === currentUser.id);
            const lastMsg = myMsgs.length > 0 ? myMsgs[myMsgs.length - 1] : null;
            if (lastMsg && lastMsg.from === 'admin') {
                alertsHtml += `<div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-3 mb-2 text-sm">
                    <p class="font-bold">æ–°è¨Šæ¯</p>
                    <p>ç®¡ç†å“¡ï¼š${lastMsg.content}</p>
                </div>`;
            }

            notificationBox.innerHTML = alertsHtml;

            const allOrders = orders;
            const myOrders = allOrders.filter(o => o.uid === currentUser.id).sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            document.getElementById('profile-orders').innerHTML = myOrders.map(o => {
                let statusClass = 'bg-gray-200 text-gray-700';
                let statusText = 'å¾…æ ¸å°';
                let borderClass = 'border-gray-300';
                let confirmedIndicator = '';

                if(o.status === 'confirmed') { 
                    statusClass = 'bg-green-100 text-green-700'; 
                    statusText = 'è¨‚å–®æˆç«‹'; 
                    borderClass = 'border-green-500 border-l-4';
                    confirmedIndicator = '<span class="text-green-600 text-xs font-bold"><i class="fas fa-check-circle"></i> å·²ç¢ºèª</span>';
                }
                
                return `
                <div class="border ${borderClass} p-3 rounded bg-white shadow-sm">
                    <div class="flex justify-between mb-2">
                        <span class="font-mono font-bold text-sm">${o.oid}</span>
                        <div class="flex items-center gap-2">
                            ${confirmedIndicator}
                            <span class="text-[10px] px-2 py-1 rounded ${statusClass}">${statusText}</span>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mb-1">${o.delivery.text}</p>
                    <p class="text-sm text-gray-600">ç¸½é‡‘é¡: $${o.total} ${o.shipping > 0 ? `(å«é‹$${o.shipping})` : ''}</p>
                    ${o.adminNote ? `<p class="text-xs bg-blue-50 p-2 mt-2 rounded text-blue-800"><i class="fas fa-info-circle"></i> ${o.adminNote}</p>` : ''}
                </div>
                `;
            }).join('') || '<p class="text-gray-400 text-sm p-2">ç„¡è¨‚å–®è¨˜éŒ„</p>';

            renderChat();
            document.getElementById('member-badge').classList.add('hide');
        }

        function saveUserProfile() {
            const name = document.getElementById('profile-name').value.trim();
            const phone = document.getElementById('profile-phone').value.trim();
            const city = document.getElementById('profile-city').value;
            const dist = document.getElementById('profile-dist').value;
            const detail = document.getElementById('profile-addr-detail').value.trim();
            const zip = document.getElementById('profile-zip').value.trim();

            if (!name || !phone) return toast('å§“åèˆ‡é›»è©±ç‚ºå¿…å¡«é …ç›®', 'error');

            const users = JSON.parse(localStorage.getItem(DB_KEYS.USERS));
            const idx = users.findIndex(u => u.id === currentUser.id);
            if (idx !== -1) {
                users[idx].name = name;
                users[idx].phone = phone;
                users[idx].addressCity = city;
                users[idx].addressDist = dist;
                users[idx].addressDetail = detail;
                users[idx].addressZip = zip;
                
                localStorage.setItem(DB_KEYS.USERS, JSON.stringify(users));
                
                currentUser = users[idx];
                sessionStorage.setItem(DB_KEYS.CURRENT_USER, JSON.stringify(currentUser));
                
                document.getElementById('nav-welcome').innerText = `æ­¡è¿, ${currentUser.name}`;
                toast('å€‹äººè³‡æ–™å·²æ›´æ–°', 'success');
            }
        }

        function renderChat() {
            const allMsgs = JSON.parse(localStorage.getItem(DB_KEYS.MESSAGES));
            const chatBox = document.getElementById('chat-box');
            const myMsgs = allMsgs.filter(m => m.from === currentUser.id || m.to === currentUser.id);

            chatBox.innerHTML = myMsgs.map(m => {
                const isMe = m.from === currentUser.id;
                const sender = isMe ? `${currentUser.name} (${currentUser.id})` : (m.from === 'admin' ? 'ç®¡ç†å“¡' : m.from);
                return `
                <div class="flex ${isMe ? 'justify-end' : 'justify-start'}">
                    <div class="max-w-[80%] rounded p-2 text-sm ${isMe ? 'bg-blue-100' : 'bg-white border'}">
                        <p class="font-bold text-xs text-gray-500 mb-1">${sender}</p>
                        <p>${m.content}</p>
                    </div>
                </div>
                `;
            }).join('');
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function sendMessage(role) {
            const input = document.getElementById('chat-input');
            const content = input.value.trim();
            if(!content) return;

            const msg = {
                from: currentUser.id,
                to: 'admin',
                content: content,
                time: new Date().toISOString()
            };

            addMessageToDB(msg);
            input.value = '';
            renderChat();
        }

        function addMessage(from, to, content) {
             const msg = { from, to, content, time: new Date().toISOString() };
             addMessageToDB(msg);
        }

        function addMessageToDB(msg) {
            const msgs = JSON.parse(localStorage.getItem(DB_KEYS.MESSAGES));
            msgs.push(msg);
            localStorage.setItem(DB_KEYS.MESSAGES, JSON.stringify(msgs));
        }

        function updatePassword() {
            const newPass = document.getElementById('new-password').value.trim();
            if(!newPass) return;
            
            const users = JSON.parse(localStorage.getItem(DB_KEYS.USERS));
            const idx = users.findIndex(u => u.id === currentUser.id);
            if(idx !== -1) {
                users[idx].pass = newPass;
                localStorage.setItem(DB_KEYS.USERS, JSON.stringify(users));
                currentUser.pass = newPass;
                sessionStorage.setItem(DB_KEYS.CURRENT_USER, JSON.stringify(currentUser));
                toast('å¯†ç¢¼å·²æ›´æ–°', 'success');
                document.getElementById('new-password').value = '';
            }
        }

        function renderAdmin() {
            const orders = JSON.parse(localStorage.getItem(DB_KEYS.ORDERS));
            const pending = orders.filter(o => o.status === 'pending');
            const confirmed = orders.filter(o => o.status === 'confirmed').sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));

            document.getElementById('count-orders-pending').innerText = pending.length;
            document.getElementById('count-orders-confirmed').innerText = confirmed.length;

            document.getElementById('admin-orders-pending').innerHTML = pending.map(o => `
                <div class="bg-white p-3 rounded shadow border-l-4 border-yellow-400">
                    <div class="flex justify-between">
                        <span class="font-bold text-sm">${o.oid}</span>
                        <span class="text-xs text-gray-500">${new Date(o.timestamp).toLocaleString()}</span>
                    </div>
                    <p class="text-sm">æœƒå“¡: ${o.uid}</p>
                    <p class="text-xs text-gray-600 my-1">${o.delivery.text}</p>
                    <p class="text-sm font-bold">ç›®å‰ç¸½é¡: $${o.total}</p>
                    <button onclick="openOrderReview('${o.oid}')" class="mt-2 w-full bg-yellow-500 text-white text-sm py-1 rounded hover:bg-yellow-600">æ ¸å°ä¸¦èª¿æ•´</button>
                </div>
            `).join('') || '<p class="text-gray-400 text-sm text-center">ç„¡å¾…æ ¸å°è¨‚å–®</p>';

            document.getElementById('admin-orders-confirmed').innerHTML = confirmed.map(o => `
                <div class="bg-white p-3 rounded shadow border-l-4 border-green-400">
                     <div class="flex justify-between">
                        <div class="flex items-center gap-2">
                            <input type="checkbox" class="order-checkbox" value="${o.oid}">
                            <span class="font-bold text-sm">${o.oid}</span>
                        </div>
                        <span class="text-xs text-gray-500">${new Date(o.timestamp).toLocaleString()}</span>
                    </div>
                    <p class="text-sm">æœƒå“¡: ${o.uid} | é‡‘é¡: $${o.total}</p>
                    <p class="text-xs text-gray-500 mb-1">${o.delivery.text}</p>
                    <div class="mt-1 flex gap-2">
                        <button onclick="printOrder('${o.oid}')" class="bg-gray-700 text-white text-xs px-2 py-1 rounded hover:bg-gray-800 transition"><i class="fas fa-print"></i> åˆ—å°</button>
                        <button onclick="openOrderReview('${o.oid}')" class="bg-yellow-500 text-white text-xs px-2 py-1 rounded mr-1 hover:bg-yellow-600 transition"><i class="fas fa-edit"></i> ä¿®æ”¹/æª¢è¦–</button>
                        <input type="text" id="msg-input-${o.oid}" class="border rounded text-xs p-1 flex-grow" placeholder="çµ¦æœƒå“¡ç•™è¨€...">
                        <button onclick="adminReplyOrder('${o.oid}', '${o.uid}')" class="bg-blue-500 text-white text-xs px-2 rounded hover:bg-blue-600 transition">ç™¼é€</button>
                    </div>
                </div>
            `).join('');

            renderAdminProducts();
            renderAdminUsers();
            renderAdminMessages();
            if(adminChatTarget) renderAdminChatBox();
        }

        function checkAdminBadges() {
            const orders = JSON.parse(localStorage.getItem(DB_KEYS.ORDERS));
            const pendingOrders = orders.filter(o => o.status === 'pending').length;
            const badgeOrders = document.getElementById('badge-admin-orders');
            if(pendingOrders > 0) {
                badgeOrders.innerText = pendingOrders;
                badgeOrders.classList.remove('hide');
            } else {
                badgeOrders.classList.add('hide');
            }

            const users = JSON.parse(localStorage.getItem(DB_KEYS.USERS));
            const pendingUsers = users.filter(u => u.status === 'pending').length;
            const badgeUsers = document.getElementById('badge-admin-users');
            if(pendingUsers > 0) {
                badgeUsers.innerText = pendingUsers;
                badgeUsers.classList.remove('hide');
                document.getElementById('admin-global-badge').classList.remove('hide');
            } else {
                badgeUsers.classList.add('hide');
                document.getElementById('admin-global-badge').classList.add('hide');
            }

            const msgs = JSON.parse(localStorage.getItem(DB_KEYS.MESSAGES));
            const lastMsg = msgs.length > 0 ? msgs[msgs.length - 1] : null;
            const badgeMsg = document.getElementById('badge-admin-msgs');
            if(lastMsg && lastMsg.to === 'admin') {
                badgeMsg.classList.remove('hide');
            } else {
                badgeMsg.classList.add('hide');
            }
        }

        function checkMemberBadges() {
            if(!currentUser) return;
            const orders = JSON.parse(localStorage.getItem(DB_KEYS.ORDERS));
            const msgs = JSON.parse(localStorage.getItem(DB_KEYS.MESSAGES));
            
            const hasConfirmed = orders.some(o => o.uid === currentUser.id && o.status === 'confirmed');
            const lastMsg = msgs.filter(m => m.to === currentUser.id).pop();
            const hasNewMsg = lastMsg && lastMsg.from === 'admin';

            const badge = document.getElementById('member-badge');
            if(hasConfirmed || hasNewMsg) {
                badge.classList.remove('hide');
            } else {
                badge.classList.add('hide');
            }
        }

        function switchAdminTab(tab, btn) {
            document.querySelectorAll('.admin-tab-content').forEach(el => el.classList.add('hide'));
            document.getElementById(`admin-content-${tab}`).classList.remove('hide');
            
            btn.parentElement.querySelectorAll('button').forEach(b => {
                b.classList.remove('bg-gray-200');
                b.classList.add('bg-gray-100');
            });
            btn.classList.remove('bg-gray-100');
            btn.classList.add('bg-gray-200');
        }

        function renderAdminProducts() {
            const products = JSON.parse(localStorage.getItem(DB_KEYS.PRODUCTS));
            document.getElementById('admin-product-list').innerHTML = products.map(p => {
                const cost = p.cost || 0;
                const profit = p.price - cost;
                return `
                <tr class="border-b">
                    <td class="p-3">${p.id}</td>
                    <td class="p-3"><img src="${p.img}" class="w-8 h-8 object-cover"></td>
                    <td class="p-3">${p.name}</td>
                    <td class="p-3">${p.category}</td>
                    <td class="p-3">$${cost}</td>
                    <td class="p-3">$${p.price}</td>
                    <td class="p-3 text-green-600 font-bold">$${profit}</td>
                    <td class="p-3">
                        <button onclick="openAdminProductModal(${p.id})" class="text-blue-600 mr-2"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteProduct(${p.id})" class="text-red-600"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `}).join('');
        }

        function openAdminProductModal(pid = null) {
             const modalTitle = document.getElementById('modal-admin-prod-title');
             if (pid) {
                const products = JSON.parse(localStorage.getItem(DB_KEYS.PRODUCTS));
                const p = products.find(i => i.id === pid);
                if (!p) return;
                
                editingProductId = pid;
                modalTitle.innerText = "ä¿®æ”¹å•†å“";
                document.getElementById('modal-prod-name').value = p.name;
                document.getElementById('modal-prod-cost').value = p.cost || '';
                document.getElementById('modal-prod-price').value = p.price;
                document.getElementById('modal-prod-cat').value = p.category;
                document.getElementById('modal-prod-img').value = p.img;
             } else {
                editingProductId = null;
                modalTitle.innerText = "æ–°å¢å•†å“";
                document.getElementById('modal-prod-name').value = '';
                document.getElementById('modal-prod-cost').value = '';
                document.getElementById('modal-prod-price').value = '';
                document.getElementById('modal-prod-cat').value = '';
                document.getElementById('modal-prod-img').value = '';
             }
             document.getElementById('modal-admin-product').classList.remove('hide');
        }

        function saveProduct() {
            const name = document.getElementById('modal-prod-name').value;
            const cost = Number(document.getElementById('modal-prod-cost').value);
            const price = Number(document.getElementById('modal-prod-price').value);
            const cat = document.getElementById('modal-prod-cat').value;
            const img = document.getElementById('modal-prod-img').value;

            if(!name || !price) return toast('è«‹å¡«å¯«å®Œæ•´', 'error');

            const products = JSON.parse(localStorage.getItem(DB_KEYS.PRODUCTS));
            
            if (editingProductId) {
                const idx = products.findIndex(p => p.id === editingProductId);
                if(idx !== -1) {
                    products[idx] = { ...products[idx], name, price, cost, category: cat, img };
                    toast('å•†å“å·²æ›´æ–°', 'success');
                }
            } else {
                const newId = products.length > 0 ? Math.max(...products.map(p => p.id)) + 1 : 1;
                products.push({ id: newId, name, price, cost, category: cat, img });
                toast('å•†å“å·²æ–°å¢', 'success');
            }

            localStorage.setItem(DB_KEYS.PRODUCTS, JSON.stringify(products));
            closeModal('modal-admin-product');
            renderAdminProducts();
        }

        function deleteProduct(id) {
            if(!confirm('ç¢ºå®šåˆªé™¤?')) return;
            let products = JSON.parse(localStorage.getItem(DB_KEYS.PRODUCTS));
            products = products.filter(p => p.id !== id);
            localStorage.setItem(DB_KEYS.PRODUCTS, JSON.stringify(products));
            renderAdminProducts();
        }

        function resetProductForm() {
            editingProductId = null;
            document.getElementById('prod-name').value = '';
            document.getElementById('prod-price').value = '';
            document.getElementById('prod-cat').value = '';
            document.getElementById('prod-img').value = '';
        }

        function renderAdminUsers() {
            const users = JSON.parse(localStorage.getItem(DB_KEYS.USERS));
            const pendingUsers = users.filter(u => u.status === 'pending');
            const activeUsers = users.filter(u => u.status !== 'pending' && u.role !== 'admin');

            const pendingContainer = document.getElementById('admin-users-pending-container');
            const pendingList = document.getElementById('admin-user-list-pending');
            
            if(pendingUsers.length > 0) {
                pendingContainer.classList.remove('hide');
                pendingList.innerHTML = pendingUsers.map(u => `
                    <tr class="border-b bg-red-50">
                        <td class="p-3 font-bold">${u.name} <br><span class="text-xs text-gray-600">${u.id}</span></td>
                        <td class="p-3 text-xs">
                            ${u.gender === 'male' ? 'ç”·' : (u.gender === 'female' ? 'å¥³' : 'å…¶ä»–')} / ${u.phone || 'ç„¡'}
                            <br>${u.birthday || ''}
                        </td>
                        <td class="p-3 flex items-center gap-2">
                            <select id="approve-level-${u.id}" class="border rounded text-xs p-1">
                                <option value="0">ä¸€èˆ¬æœƒå“¡</option>
                                <option value="1">VIPæœƒå“¡</option>
                            </select>
                            <button onclick="approveUserWithLevel('${u.id}')" class="bg-green-600 text-white text-xs px-3 py-1 rounded shadow hover:bg-green-700">å¯©æ ¸é€šé</button>
                        </td>
                    </tr>
                `).join('');
            } else {
                pendingContainer.classList.add('hide');
            }

            document.getElementById('admin-user-list-active').innerHTML = activeUsers.map(u => `
                <tr class="border-b">
                    <td class="p-3">${u.name} <br><span class="text-xs text-gray-500">${u.id}</span></td>
                    <td class="p-3 text-xs">
                        ${u.gender === 'male' ? 'ç”·' : (u.gender === 'female' ? 'å¥³' : 'å…¶ä»–')} / ${u.phone || 'ç„¡'}
                        <br>${u.birthday || ''}
                    </td>
                    <td class="p-3">
                        <span class="px-2 py-1 text-xs rounded bg-green-100 text-green-700">æ­£å¸¸</span>
                    </td>
                    <td class="p-3">
                         <select onchange="updateUserLevel('${u.id}', this.value)" class="border rounded text-sm">
                            <option value="0" ${u.level === 0 ? 'selected' : ''}>ä¸€èˆ¬</option>
                            <option value="1" ${u.level === 1 ? 'selected' : ''}>VIP</option>
                         </select>
                    </td>
                    <td class="p-3">
                        <button onclick="openAdminUserModal('${u.id}')" class="text-xs bg-blue-600 text-white px-2 py-1 rounded ml-1">ä¿®æ”¹</button>
                    </td>
                </tr>
            `).join('');
        }

        function openAdminUserModal(uid = null) {
            const modalTitle = document.getElementById('modal-admin-user-title');
            const idInput = document.getElementById('adm-user-id');
            const passInput = document.getElementById('adm-user-pass');
            const citySelect = document.getElementById('adm-user-city');
            const distSelect = document.getElementById('adm-user-dist');
            const zipInput = document.getElementById('adm-user-zip');

            if (uid) {
                const users = JSON.parse(localStorage.getItem(DB_KEYS.USERS));
                const user = users.find(u => u.id === uid);
                if (!user) return;
                
                editingUserId = uid;
                modalTitle.innerText = "ä¿®æ”¹æœƒå“¡è³‡æ–™";
                idInput.value = user.id;
                idInput.disabled = true; 
                idInput.classList.add('bg-gray-100', 'cursor-not-allowed');
                
                document.getElementById('adm-user-name').value = user.name;
                document.getElementById('adm-user-phone').value = user.phone || '';
                
                initAddressSelectors('adm-user-city', 'adm-user-dist', 'adm-user-zip', user.addressCity, user.addressDist);
                if(user.addressZip) zipInput.value = user.addressZip;
                document.getElementById('adm-user-addr-detail').value = user.addressDetail || '';

                document.getElementById('adm-user-level').value = user.level;
                passInput.placeholder = "ç•™ç©ºå‰‡ä¸ä¿®æ”¹";
            } else {
                editingUserId = null;
                modalTitle.innerText = "æ–°å¢æœƒå“¡";
                idInput.value = '';
                idInput.disabled = false;
                idInput.classList.remove('bg-gray-100', 'cursor-not-allowed');
                
                document.getElementById('adm-user-name').value = '';
                document.getElementById('adm-user-phone').value = '';
                initAddressSelectors('adm-user-city', 'adm-user-dist', 'adm-user-zip', '', '');
                document.getElementById('adm-user-addr-detail').value = '';
                document.getElementById('adm-user-level').value = 0;
                passInput.placeholder = "è«‹è¼¸å…¥å¯†ç¢¼";
            }
            document.getElementById('modal-admin-user').classList.remove('hide');
        }

        function saveAdminUser() {
            const id = document.getElementById('adm-user-id').value.trim();
            const pass = document.getElementById('adm-user-pass').value.trim();
            const name = document.getElementById('adm-user-name').value.trim();
            const phone = document.getElementById('adm-user-phone').value.trim();
            const level = parseInt(document.getElementById('adm-user-level').value);
            
            const city = document.getElementById('adm-user-city').value;
            const dist = document.getElementById('adm-user-dist').value;
            const zip = document.getElementById('adm-user-zip').value;
            const detail = document.getElementById('adm-user-addr-detail').value.trim();

            if (!id || !name) return toast('å¸³è™Ÿèˆ‡å§“åç‚ºå¿…å¡«', 'error');

            const users = JSON.parse(localStorage.getItem(DB_KEYS.USERS));

            if (editingUserId) {
                const idx = users.findIndex(u => u.id === editingUserId);
                if (idx !== -1) {
                    users[idx].name = name;
                    users[idx].phone = phone;
                    users[idx].level = level;
                    users[idx].addressCity = city;
                    users[idx].addressDist = dist;
                    users[idx].addressDetail = detail;
                    users[idx].addressZip = zip;
                    if (pass) users[idx].pass = pass;
                    
                    toast('æœƒå“¡è³‡æ–™å·²æ›´æ–°', 'success');
                }
            } else {
                if (!pass) return toast('æ–°å¢æœƒå“¡éœ€è¨­å®šå¯†ç¢¼', 'error');
                if (users.some(u => u.id === id)) return toast('å¸³è™Ÿå·²å­˜åœ¨', 'error');

                users.push({
                    id, pass, name, phone, level,
                    addressCity: city,
                    addressDist: dist,
                    addressDetail: detail,
                    addressZip: zip,
                    role: 'user',
                    status: 'active', 
                    joined: new Date().toISOString()
                });
                toast('æœƒå“¡å·²æ–°å¢', 'success');
            }

            localStorage.setItem(DB_KEYS.USERS, JSON.stringify(users));
            closeModal('modal-admin-user');
            renderAdminUsers();
        }

        function closeModal(id) {
            document.getElementById(id).classList.add('hide');
        }

        function approveUserWithLevel(uid) {
            const levelSelect = document.getElementById(`approve-level-${uid}`);
            const level = parseInt(levelSelect.value);
            
            const users = JSON.parse(localStorage.getItem(DB_KEYS.USERS));
            const user = users.find(u => u.id === uid);
            
            if(user) {
                user.status = 'active';
                user.level = level; 
                localStorage.setItem(DB_KEYS.USERS, JSON.stringify(users));
                
                const levelName = level === 1 ? "VIPæœƒå“¡" : "ä¸€èˆ¬æœƒå“¡";
                addMessage('admin', uid, `æ‚¨çš„å¸³è™Ÿå·²å¯©æ ¸é€šéï¼Œç›®å‰ç­‰ç´šç‚ºï¼š${levelName}ï¼Œæ­¡è¿é–‹å§‹è³¼ç‰©ï¼`);
                
                toast(`æœƒå“¡å·²é–‹é€š (ç­‰ç´š: ${levelName})`, 'success');
                renderAdminUsers();
                checkAdminBadges();
            }
        }

        function updateUserLevel(uid, lvl) {
            const users = JSON.parse(localStorage.getItem(DB_KEYS.USERS));
            const user = users.find(u => u.id === uid);
            if(user) {
                user.level = Number(lvl);
                localStorage.setItem(DB_KEYS.USERS, JSON.stringify(users));
                toast('æœƒå“¡ç­‰ç´šå·²æ›´æ–°', 'success');
            }
        }
        
        function resetUserPass(uid) {
            const newPass = prompt(`è«‹è¼¸å…¥ ${uid} çš„æ–°å¯†ç¢¼:`);
            if(newPass) {
                const users = JSON.parse(localStorage.getItem(DB_KEYS.USERS));
                const user = users.find(u => u.id === uid);
                user.pass = newPass;
                localStorage.setItem(DB_KEYS.USERS, JSON.stringify(users));
                toast('å¯†ç¢¼å·²ä¿®æ”¹', 'success');
            }
        }

        function renderAdminMessages() {
            const msgs = JSON.parse(localStorage.getItem(DB_KEYS.MESSAGES));
            const users = JSON.parse(localStorage.getItem(DB_KEYS.USERS)).filter(u => u.role !== 'admin');
            
            const list = document.getElementById('admin-msg-list');
            list.innerHTML = users.map(u => {
                const userMsgs = msgs.filter(m => m.from === u.id || m.to === u.id);
                const lastMsg = userMsgs.length > 0 ? userMsgs[userMsgs.length - 1].content : 'å°šç„¡è¨Šæ¯';
                const isPending = u.status === 'pending';
                const isActive = adminChatTarget === u.id;
                
                return `
                <div onclick="openAdminChat('${u.id}')" class="p-3 border-b cursor-pointer hover:bg-gray-50 ${isActive ? 'bg-blue-50' : ''}">
                    <div class="flex justify-between items-center">
                        <span class="font-bold text-sm">${u.name} (${u.id})</span>
                        ${isPending ? '<span class="text-[10px] bg-yellow-400 text-white px-1 rounded">å¾…å¯©æ ¸</span>' : ''}
                    </div>
                    <p class="text-xs text-gray-500 truncate">${lastMsg}</p>
                </div>
                `;
            }).join('');
        }

        function openAdminChat(uid) {
            adminChatTarget = uid;
            renderAdminMessages();
            renderAdminChatBox();
        }

        function renderAdminChatBox() {
            if(!adminChatTarget) return;
            const uid = adminChatTarget;
            const users = JSON.parse(localStorage.getItem(DB_KEYS.USERS));
            const targetUser = users.find(u => u.id === uid);
            const targetName = targetUser ? targetUser.name : uid;

            document.getElementById('admin-chat-header').innerText = `èˆ‡ ${targetName} (${uid}) çš„å°è©±`;
            document.getElementById('admin-chat-input').disabled = false;
            document.getElementById('admin-chat-send-btn').disabled = false;
            
            const msgs = JSON.parse(localStorage.getItem(DB_KEYS.MESSAGES));
            const chatMsgs = msgs.filter(m => m.from === uid || m.to === uid);
            
            const box = document.getElementById('admin-chat-box');
            box.innerHTML = chatMsgs.map(m => {
                const isAdmin = m.from === 'admin';
                const senderDisplay = isAdmin ? 'ç®¡ç†å“¡' : `${targetName} (${m.from})`;
                return `
                <div class="flex ${isAdmin ? 'justify-end' : 'justify-start'}">
                    <div class="max-w-[80%] rounded p-2 text-sm ${isAdmin ? 'bg-blue-100' : 'bg-white border'}">
                         <p class="font-bold text-xs text-gray-500 mb-1">${senderDisplay}</p>
                        <p>${m.content}</p>
                        <p class="text-[10px] text-gray-400 text-right mt-1">${new Date(m.time).toLocaleString()}</p>
                    </div>
                </div>
                `;
            }).join('');
            box.scrollTop = box.scrollHeight;
        }

        function adminSendMsg() {
            if(!adminChatTarget) return;
            const input = document.getElementById('admin-chat-input');
            const text = input.value.trim();
            if(!text) return;
            
            addMessage('admin', adminChatTarget, text);
            input.value = '';
            renderAdminChatBox();
            renderAdminMessages();
        }

        function openOrderReview(oid) {
            const orders = JSON.parse(localStorage.getItem(DB_KEYS.ORDERS));
            const users = JSON.parse(localStorage.getItem(DB_KEYS.USERS));
            reviewingOrder = orders.find(o => o.oid === oid);
            if(!reviewingOrder) return;

            const orderUser = users.find(u => u.id === reviewingOrder.uid);
            const userName = orderUser ? orderUser.name : 'æœªçŸ¥';

            reviewingOrder.items.forEach(i => {
                if(typeof i.stockStatus === 'undefined') i.stockStatus = 'in_stock';
            });

            document.getElementById('review-member-info').innerText = `${userName} (${reviewingOrder.uid})`;
            document.getElementById('review-delivery-info').innerText = reviewingOrder.delivery.text;

            const isConfirmed = reviewingOrder.status === 'confirmed';
            const btnFn = document.getElementById('btn-confirm-order');
            
            if(isConfirmed) {
                btnFn.innerText = "æ›´æ–°è¨‚å–®ä¸¦é€šçŸ¥";
                btnFn.classList.replace('bg-green-600', 'bg-blue-600');
                btnFn.classList.replace('hover:bg-green-700', 'hover:bg-blue-700');
                document.getElementById('review-msg').value = `è¦ªæ„›çš„æœƒå“¡ï¼Œæ‚¨çš„è¨‚å–® ${oid} å…§å®¹å·²æ›´æ–°ã€‚\n\nè«‹ç¢ºèªæœ€æ–°çš„è¨‚å–®è³‡è¨Šã€‚\nç¸½é‡‘é¡ï¼š$${reviewingOrder.total}\n\nå¦‚æœ‰å•é¡Œè«‹è¯ç¹«æˆ‘å€‘ã€‚`;
            } else {
                btnFn.innerText = "ç¢ºèªè¨‚å–®ä¸¦é€šçŸ¥";
                btnFn.classList.replace('bg-blue-600', 'bg-green-600');
                btnFn.classList.replace('hover:bg-blue-700', 'hover:bg-green-700');
                document.getElementById('review-msg').value = `è¦ªæ„›çš„æœƒå“¡ï¼Œæ‚¨çš„è¨‚å–® ${oid} å·²ç¢ºèªã€‚\n\nè«‹åŒ¯æ¬¾è‡³ï¼š\néŠ€è¡Œä»£è™Ÿï¼š000\nå¸³è™Ÿï¼š1234-5678-9000\né‡‘é¡ï¼š$${reviewingOrder.total}\n\nåŒ¯æ¬¾å¾Œè«‹é€šçŸ¥æˆ‘å€‘ï¼Œè¬è¬ï¼`;
            }

            renderReviewItems();
            updateReviewTotals();
            
            document.getElementById('modal-order-review').classList.remove('hide');
        }

        function renderReviewItems() {
            const list = document.getElementById('order-review-items');
            list.innerHTML = reviewingOrder.items.map((item, idx) => {
                const isOutOfStock = item.stockStatus === 'out_of_stock';
                return `
                <tr class="border-b ${isOutOfStock ? 'bg-gray-100 text-gray-400' : ''}">
                    <td class="p-2">
                        <p class="font-bold text-sm">${item.name}</p>
                        <p class="text-xs text-gray-500">åŸåƒ¹: ${item.originalPrice}</p>
                    </td>
                    <td class="p-2">
                        <input type="number" value="${item.qty}" min="0" 
                            onchange="updateOrderItemQty('${reviewingOrder.oid}', ${idx}, this.value)" 
                            class="w-16 border rounded p-1 text-sm text-center" ${isOutOfStock ? 'disabled' : ''}>
                    </td>
                    <td class="p-2">
                        <input type="number" value="${item.finalPrice}" 
                            onchange="updateOrderItemPrice('${reviewingOrder.oid}', ${idx}, this.value)" 
                            class="w-20 border rounded p-1 text-sm text-right" ${isOutOfStock ? 'disabled' : ''}>
                    </td>
                    <td class="p-2">
                        <select onchange="updateOrderItemStatus('${reviewingOrder.oid}', ${idx}, this.value)" 
                            class="border rounded p-1 text-xs ${isOutOfStock ? 'text-red-500 font-bold' : 'text-green-600'}">
                            <option value="in_stock" ${!isOutOfStock ? 'selected' : ''}>æ­£å¸¸</option>
                            <option value="out_of_stock" ${isOutOfStock ? 'selected' : ''}>ç¼ºè²¨</option>
                        </select>
                    </td>
                </tr>
            `}).join('');
        }

        function updateOrderItemStatus(oid, idx, status) {
            if (reviewingOrder && reviewingOrder.oid === oid) {
                reviewingOrder.items[idx].stockStatus = status;
                renderReviewItems();
                updateReviewTotals();
            }
        }

        function updateOrderItemQty(oid, idx, qty) {
            qty = Number(qty);
            if (reviewingOrder && reviewingOrder.oid === oid && qty >= 0) {
                reviewingOrder.items[idx].qty = qty;
                updateReviewTotals();
            }
        }

        function updateOrderItemPrice(oid, idx, newPrice) {
            newPrice = Number(newPrice);
            if (reviewingOrder && reviewingOrder.oid === oid) {
                reviewingOrder.items[idx].finalPrice = newPrice;
                updateReviewTotals();
            }
        }

        function updateReviewTotals() {
            if (!reviewingOrder) return;
            
            const subtotal = reviewingOrder.items.reduce((acc, i) => {
                return i.stockStatus === 'out_of_stock' ? acc : acc + (i.finalPrice * i.qty);
            }, 0);

            reviewingOrder.total = subtotal + reviewingOrder.shipping;
            
            document.getElementById('review-shipping-fee').innerText = reviewingOrder.shipping;
            document.getElementById('review-final-total').innerText = reviewingOrder.total;
            
            const msgBox = document.getElementById('review-msg');
            if (reviewingOrder.status === 'confirmed') {
                 msgBox.value = `è¦ªæ„›çš„æœƒå“¡ï¼Œæ‚¨çš„è¨‚å–® ${reviewingOrder.oid} å…§å®¹å·²æ›´æ–°ã€‚\n\næœ€æ–°ç¸½é‡‘é¡ï¼š$${reviewingOrder.total}\n\nè«‹ç¢ºèªï¼Œè¬è¬ï¼`;
            } else {
                 msgBox.value = `è¦ªæ„›çš„æœƒå“¡ï¼Œæ‚¨çš„è¨‚å–® ${reviewingOrder.oid} å·²ç¢ºèªã€‚\n\nè«‹åŒ¯æ¬¾è‡³ï¼š\néŠ€è¡Œä»£è™Ÿï¼š000\nå¸³è™Ÿï¼š1234-5678-9000\né‡‘é¡ï¼š$${reviewingOrder.total}\n\nåŒ¯æ¬¾å¾Œè«‹é€šçŸ¥æˆ‘å€‘ï¼Œè¬è¬ï¼`;
            }
        }

        function confirmOrderAction() {
            if(!reviewingOrder) return;
            
            const orders = JSON.parse(localStorage.getItem(DB_KEYS.ORDERS));
            const idx = orders.findIndex(o => o.oid === reviewingOrder.oid);
            if(idx !== -1) {
                const msg = document.getElementById('review-msg').value;
                orders[idx] = reviewingOrder;
                orders[idx].status = 'confirmed';
                orders[idx].adminNote = msg; 
                
                localStorage.setItem(DB_KEYS.ORDERS, JSON.stringify(orders));
                
                addMessage('admin', reviewingOrder.uid, msg);

                exportOrderToCSV(reviewingOrder);

                toast('è¨‚å–®å·²ç¢ºèªä¸¦é€šçŸ¥æœƒå“¡ï¼ŒExcelå ±è¡¨å·²ä¸‹è¼‰', 'success');
                closeModal('modal-order-review');
                renderAdmin();
                reviewingOrder = null;
            }
        }

        function exportOrderToCSV(order) {
            let csvContent = "\uFEFF"; 
            csvContent += "è¨‚å–®ç·¨è™Ÿ,è¨‚å–®æ—¥æœŸ,æœƒå“¡å¸³è™Ÿ,ç¸½é‡‘é¡,é…é€æ–¹å¼,é‹è²»\n";
            const orderDate = new Date(order.timestamp).toLocaleString();
            csvContent += `${order.oid},"${orderDate}",${order.uid},${order.total},"${order.delivery.text}",${order.shipping}\n\n`;
            csvContent += "å•†å“åç¨±,å–®åƒ¹,æ•¸é‡,ç‹€æ…‹,å°è¨ˆ\n";
            order.items.forEach(item => {
                const status = item.stockStatus === 'out_of_stock' ? 'ç¼ºè²¨' : 'æ­£å¸¸';
                const subtotal = item.stockStatus === 'out_of_stock' ? 0 : item.finalPrice * item.qty;
                csvContent += `"${item.name}",${item.finalPrice},${item.qty},${status},${subtotal}\n`;
            });
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", `è¨‚å–®å ±è¡¨_${order.oid}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function printOrder(oid) {
            const orders = JSON.parse(localStorage.getItem(DB_KEYS.ORDERS));
            const order = orders.find(o => o.oid === oid);
            if (!order) return;
            
            renderPrintView([order]);
        }

        function printSelectedOrders() {
            const checkboxes = document.querySelectorAll('.order-checkbox:checked');
            if (checkboxes.length === 0) return toast('è«‹å…ˆå‹¾é¸è¦åˆ—å°çš„è¨‚å–®', 'warning');
            
            const selectedOids = Array.from(checkboxes).map(cb => cb.value);
            const orders = JSON.parse(localStorage.getItem(DB_KEYS.ORDERS));
            const selectedOrders = orders.filter(o => selectedOids.includes(o.oid));
            
            renderPrintView(selectedOrders);
        }

        function renderPrintView(ordersToPrint) {
            const users = JSON.parse(localStorage.getItem(DB_KEYS.USERS)) || [];
            const printWindow = window.open('', '_blank');
            let html = `
            <html>
            <head>
                <title>è¨‚å–®åˆ—å°</title>
                <style>
                    body { font-family: 'Noto Sans TC', sans-serif; padding: 20px; }
                    .order-container { border: 1px solid #ccc; padding: 20px; margin-bottom: 20px; page-break-after: always; }
                    h2 { text-align: center; border-bottom: 2px solid #333; padding-bottom: 10px; }
                    .info-grid { display: grid; grid-template-columns: 1fr 1fr; margin-bottom: 20px; }
                    table { w-full; border-collapse: collapse; width: 100%; margin-bottom: 20px; }
                    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                    th { background-color: #f2f2f2; }
                    .total-row { text-align: right; font-weight: bold; font-size: 1.2em; }
                    .footer { text-align: center; font-size: 0.8em; color: #666; margin-top: 30px; }
                </style>
            </head>
            <body>`;

            ordersToPrint.forEach(order => {
                const user = users.find(u => u.id === order.uid);
                const userName = user ? user.name : 'æœªçŸ¥';
                const date = new Date(order.timestamp).toLocaleString();
                let itemsHtml = '';
                order.items.forEach(item => {
                    const status = item.stockStatus === 'out_of_stock' ? '(ç¼ºè²¨)' : '';
                    const sub = item.stockStatus === 'out_of_stock' ? 0 : item.finalPrice * item.qty;
                    itemsHtml += `<tr><td>${item.name} ${status}</td><td>${item.finalPrice}</td><td>${item.qty}</td><td>${sub}</td></tr>`;
                });

                html += `
                <div class="order-container">
                    <h2>JCmarket å‡ºè²¨å–®</h2>
                    <div class="info-grid">
                        <div>
                            <p><strong>è¨‚å–®ç·¨è™Ÿ:</strong> ${order.oid}</p>
                            <p><strong>æœƒå“¡è³‡æ–™:</strong> ${userName} (${order.uid})</p>
                            <p><strong>è¨‚è³¼æ—¥æœŸ:</strong> ${date}</p>
                        </div>
                        <div>
                            <p><strong>é…é€æ–¹å¼:</strong> ${order.delivery.type === 'pickup' ? 'åˆ°åº—è‡ªå–' : 'å®…é…'}</p>
                            <p><strong>é…é€è³‡è¨Š:</strong> ${order.delivery.text}</p>
                        </div>
                    </div>
                    <table>
                        <thead><tr><th>å•†å“åç¨±</th><th>å–®åƒ¹</th><th>æ•¸é‡</th><th>å°è¨ˆ</th></tr></thead>
                        <tbody>${itemsHtml}</tbody>
                    </table>
                    <div class="total-row">
                        <p>é‹è²»: $${order.shipping}</p>
                        <p>ç¸½é‡‘é¡: $${order.total}</p>
                    </div>
                    <div class="footer">
                        æ„Ÿè¬æ‚¨çš„è¨‚è³¼ï¼å¦‚æœ‰å•é¡Œè«‹è¯ç¹«å®¢æœã€‚<br>
                        JCmarket è³¼ç‰©ç¶²
                    </div>
                </div>`;
            });

            html += `<script>window.print();<\/script></body></html>`;
            printWindow.document.write(html);
            printWindow.document.close();
        }

        function adminReplyOrder(oid, uid) {
            const input = document.getElementById(`msg-input-${oid}`);
            const text = input.value.trim();
            if(text) {
                addMessage('admin', uid, `[è¨‚å–® ${oid}] ${text}`);
                input.value = '';
                toast('è¨Šæ¯å·²ç™¼é€', 'success');
            }
        }

        function exportData() {
            const data = {
                users: JSON.parse(localStorage.getItem(DB_KEYS.USERS)),
                products: JSON.parse(localStorage.getItem(DB_KEYS.PRODUCTS)),
                orders: JSON.parse(localStorage.getItem(DB_KEYS.ORDERS)),
                messages: JSON.parse(localStorage.getItem(DB_KEYS.MESSAGES))
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], {type : 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `jcmarket_backup_${Date.now()}.json`;
            a.click();
        }

        function importData(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if(data.users) localStorage.setItem(DB_KEYS.USERS, JSON.stringify(data.users));
                    if(data.products) localStorage.setItem(DB_KEYS.PRODUCTS, JSON.stringify(data.products));
                    if(data.orders) localStorage.setItem(DB_KEYS.ORDERS, JSON.stringify(data.orders));
                    if(data.messages) localStorage.setItem(DB_KEYS.MESSAGES, JSON.stringify(data.messages));
                    alert('è³‡æ–™åŒ¯å…¥æˆåŠŸï¼Œå³å°‡é‡æ–°æ•´ç†');
                    location.reload();
                } catch(err) {
                    alert('è³‡æ–™æ ¼å¼éŒ¯èª¤');
                }
            };
            reader.readAsText(file);
        }

        function toast(msg, type='info') {
            const container = document.getElementById('toast-container');
            const el = document.createElement('div');
            const colors = { error: 'bg-red-500', success: 'bg-green-500', warning: 'bg-yellow-500', info: 'bg-blue-500' };
            el.className = `${colors[type]} text-white px-4 py-2 rounded shadow-lg transform transition-all duration-500 translate-x-full opacity-0`;
            el.innerText = msg;
            container.appendChild(el);
            
            setTimeout(() => { el.classList.remove('translate-x-full', 'opacity-0'); }, 10);
            setTimeout(() => { 
                el.classList.add('opacity-0'); 
                setTimeout(() => el.remove(), 500); 
            }, 3000);
        }

    </script>
</body>
</html>